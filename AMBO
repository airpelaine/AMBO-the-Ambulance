<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { 
            display: flex; justify-content: center; align-items: center; 
            height: 100vh; margin: 0; background: #0f0f0f; 
            font-family: 'Segoe UI', sans-serif; color: white; overflow: hidden;
            touch-action: none;
        }
        .container { position: relative; display: flex; flex-direction: column; align-items: center; width: 100%; max-width: 400px; }
        canvas { background: #222; border: 4px solid #444; border-radius: 12px; width: 95%; height: auto; box-shadow: 0 0 30px rgba(0,212,255,0.3); }
        
        .hud-top-left { position: absolute; top: -25px; left: 10px; font-size: 14px; color: #ffcc00; font-weight: bold; }
        .hud-top-right { position: absolute; top: -25px; right: 10px; font-size: 14px; color: #00d4ff; font-weight: bold; }

        #mainOverlay {
            position: absolute; top: 10px; left: 10px; right: 10px; bottom: 80px;
            background: rgba(5, 5, 5, 0.98); border: 3px solid #00d4ff; border-radius: 15px;
            display: flex; flex-direction: column; padding: 15px; z-index: 100; box-shadow: 0 0 50px rgba(0,0,0,1);
        }
        .story-header { font-size: 22px; color: #ff3e3e; font-weight: 900; text-align: center; margin-bottom: 8px; text-transform: uppercase; }
        .story-text { font-size: 13px; font-style: italic; color: #ddd; margin-bottom: 12px; line-height: 1.5; text-align: center; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; }
        
        .question-text { font-size: 14px; margin-bottom: 10px; line-height: 1.3; color: #fff; font-weight: bold; border-bottom: 1px solid #333; padding-bottom: 8px; }
        .option-btn { 
            background: #2a2a2a; text-align: left; margin-bottom: 6px; padding: 12px; 
            border-radius: 6px; font-size: 12px; border: 1px solid #444; width: 100%; color: white;
            transition: 0.2s; cursor: pointer; -webkit-tap-highlight-color: transparent;
        }
        
        #wrongFeedback { color: #ff3e3e; font-weight: bold; text-align: center; margin-bottom: 5px; display: none; font-size: 14px; }

        .form-group { margin-bottom: 10px; text-align: left; width: 100%; }
        .form-group label { display: block; font-size: 11px; color: #00d4ff; margin-bottom: 3px; font-weight: bold; }
        .form-group input { 
            width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #444; 
            background: #1a1a1a; color: white; box-sizing: border-box; font-size: 16px;
        }

        /* Mobile Controls */
        .mobile-controls { display: flex; width: 100%; gap: 20px; margin-top: 10px; justify-content: center; }
        .ctrl-btn { 
            width: 70px; height: 70px; background: rgba(255,255,255,0.1); border: 2px solid #444; 
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            font-size: 24px; user-select: none; -webkit-tap-highlight-color: transparent;
        }
        .ctrl-btn:active { background: rgba(0,212,255,0.3); border-color: #00d4ff; }

        .progress-container { width: 90%; height: 10px; background: #333; border-radius: 10px; margin-top: 20px; border: 2px solid #444; position: relative; }
        #progressBar { width: 0%; height: 100%; background: linear-gradient(90deg, #00d4ff, #00ff88); transition: 0.4s; }
        
        .game-btn { padding: 12px 20px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: white; text-transform: uppercase; font-size: 13px; }
        .btn-green { background: #27ae60; width: 100%; }
        .btn-ui { background: #444; font-size: 11px; padding: 8px 12px; }
    </style>
</head>
<body>

<div class="container">
    <div class="hud-top-left">‚úÖ CORRECT: <span id="qCorrect">0</span> / 30</div>
    <div class="hud-top-right">üõ£Ô∏è <span id="dist">0</span>m</div>
    
    <canvas id="game" width="360" height="550"></canvas>
    
    <div id="mainOverlay">
        <div id="screenStart" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%;">
            <div class="story-header" style="font-size: 45px;">üöë AMBO</div>
            <p style="color: #888; font-size: 12px; margin-bottom: 20px;">St. Luke's Medical Center</p>
            <button class="game-btn btn-green" onclick="showScreen('screenDetails')">START MISSION</button>
        </div>

        <div id="screenDetails" style="display: none; flex-direction: column; justify-content: center; height: 100%;">
            <div class="story-header">üìã DEPLOYMENT</div>
            <div class="form-group">
                <label>ST. LUKE'S SITE</label>
                <select id="playerSite" style="width:100%; padding:10px; background:#111; color:white; border:1px solid #444;">
                    <option value="Quezon City">Quezon City</option>
                    <option value="Global City">Global City</option>
                </select>
            </div>
            <div class="form-group">
                <label>PLAYER NUMBER</label>
                <input type="number" id="playerNum" inputmode="numeric" pattern="[0-9]*" placeholder="Enter ID number">
            </div>
            <button class="game-btn btn-green" onclick="validateDetails()">CONFIRM</button>
        </div>

        <div id="screenBriefing" style="display: none; flex-direction: column; justify-content: center; height: 100%;">
            <div class="story-header">üí¨ AMBO SAYS:</div>
            <div class="story-text">
                "Hello partner! I'm <b>Ambo</b> üöë. I'll handle the driving to <b>St. Luke's <span id="displaySite"></span></b>, but I need you to manage my O-CIS terminal.
                <br><br>
                Every 1000m, I'll hit a signal dead-zone. To keep my GPS active, you must answer the competency checks correctly. If you mess up, my systems lag and we lose distance! Ready?"
            </div>
            <button class="game-btn btn-green" onclick="startMission()">üöÄ LET'S GO, AMBO!</button>
        </div>

        <div id="screenQuiz" style="display: none; flex-direction: column; justify-content: center; height: 100%;">
            <div id="wrongFeedback">‚ùå Wrong answer! I'm lagging!</div>
            <div class="question-text" id="qText">Question?</div>
            <div id="optionsContainer"></div>
        </div>
    </div>

    <div class="progress-container"><div id="progressBar"></div></div>

    <div class="mobile-controls">
        <div class="ctrl-btn" id="btnLeft">‚óÄ</div>
        <button onclick="location.reload()" class="game-btn btn-ui">RESTART</button>
        <div class="ctrl-btn" id="btnRight">‚ñ∂</div>
    </div>
</div>

<script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const distText = document.getElementById('dist');
    const qCorrectText = document.getElementById('qCorrect');
    const progBar = document.getElementById('progressBar');
    const mainOverlay = document.getElementById('mainOverlay');

    let distance = 0, isPaused = true, inQuiz = false, gameStarted = false;
    let spawnTimer = 0, roadOffset = 0, invincibilityFrames = 0, arriving = false, launchAnimation = false;
    let hospitalY = -300;
    const WIN_DISTANCE = 7000;

    const ambulance = { x: 165, y: 450, w: 35, h: 60, speed: 7 };
    let traffic = [];
    const keys = {};

    // Touch Support
    document.getElementById('btnLeft').ontouchstart = () => keys['ArrowLeft'] = true;
    document.getElementById('btnLeft').ontouchend = () => keys['ArrowLeft'] = false;
    document.getElementById('btnRight').ontouchstart = () => keys['ArrowRight'] = true;
    document.getElementById('btnRight').ontouchend = () => keys['ArrowRight'] = false;

    let currentQuestionIndex = 0;
    const questions = [
        { q: "Which URL is used to access the O-CIS portal?", a: ["hospitalportal.stluke.com.ph:3031", "10.10.60.95:8081/login", "portal.stlukes.com.ph", "ocis.stlukes.com.ph"], correct: 2 },
        { q: "Select which tab for Patient Full Name/DOB during registration?", a: ["Supplemental", "Basic", "Visit", "Clinical"], correct: 1 },
        { q: "Tick which option for critical patients to process faster?", a: ["Licensed Census", "Non-Census", "Express Registration", "VIP"], correct: 2 },
        { q: "What message appears if 'Search' finds no record?", a: ["Entry Not Found", "No Results Found", "User Unknown", "Create New"], correct: 1 },
        { q: "Select which unit for ED in QC during registration?", a: ["QC-ER", "QC-EMERGENCY", "QC-ED", "QC-TRIAGE"], correct: 2 },
        { q: "Correct path to access scanning via OPAL?", a: ["File > Scan", "Tools > Opal Scanning", "Document > Start Scan", "Tools > Paper-Based"], correct: 1 },
        { q: "What characterizes an O-CIS 'Significant Field'?", a: ["Cannot save if empty", "Can save but tagged 'Incomplete'", "Billing only", "Needs co-signer"], correct: 1 },
        { q: "Action required to view a saved document?", a: ["Single-click name", "Click Summary", "Double-click name in Documents", "Tools > Viewer"], correct: 2 },
        { q: "Co-signer radio button for Attending Physicians?", a: ["Other", "Current Provider", "Medical Director", "Referring"], correct: 1 },
        { q: "How to add a comment to a Flowsheet cell?", a: ["Double-click", "Right-click > Enter Comment", "Actions button", "Summary Views"], correct: 1 },
        { q: "Option to present Tracking Board on unit monitor?", a: ["Monitor View", "Display Board", "Unit Broadcast", "Full Screen"], correct: 1 },
        { q: "Button to stop a flowsheet parameter no longer needed?", a: ["Delete", "Cancel", "Discontinue", "Remove"], correct: 2 },
        { q: "Button to return to patient list from tracking board?", a: ["Exit Board", "Close", "Patient List", "Main Menu"], correct: 2 },
        { q: "Where can the Order Entry Worksheet be accessed?", a: ["Main Toolbar only", "Main Toolbar or Patient Header", "Flowsheet only", "Registration"], correct: 1 },
        { q: "Radio button for patient with no allergies?", a: ["N/A", "No Known Allergies", "Negative", "Unknown"], correct: 1 },
        { q: "Besides browsing, how else to search clinical orders?", a: ["Barcode scan", "Type in search field", "Filter ICD10", "Recently Used"], correct: 1 },
        { q: "What is the 'Allergy Summary View' during ordering?", a: ["Billing requirement", "System safety feature", "Medication error", "Required note"], correct: 1 },
        { q: "Status of specimen order after successful processing?", a: ["Pending Collection", "Received", "Collected", "Dispatched"], correct: 2 },
        { q: "Co-signers required for Carrying Out Blood Transfusion?", a: ["None", "One", "Two", "Three"], correct: 2 },
        { q: "Override reason if no barcode present for transfusion?", a: ["Emergency Use", "No Barcode Present", "System Offline", "Manual Entry"], correct: 1 },
        { q: "Mandatory for High Alert Medication (HAM) validation?", a: ["Physician verbal", "Witnessed/Co-Signature", "ICD10 code", "Consent"], correct: 1 },
        { q: "Rx Verify Override Reason for ER medications?", a: ["Pharmacy Closed", "Emergency Situation", "Doctor's Request", "Life Threatening"], correct: 1 },
        { q: "Which URL is specifically for CSS Charging in SLB?", a: ["10.10.60.95:8081", "hospitalportal.stluke.com.ph:3031", "portal.stlukes.com.ph", "css.stlukes.ph"], correct: 1 },
        { q: "Where to find encoded items before submitting in SLB?", a: ["Pending List", "Supply Inventory", "Order Cart", "Checked Items"], correct: 2 },
        { q: "Page to update financial class (HMO/Individual)?", a: ["O-CIS Registration", "E.R. Landing Page", "Demographics", "Billing"], correct: 1 },
        { q: "Required printout for CSS department claiming?", a: ["Orders/Charges screenshot", "Patient ID", "Physician Order", "Admission form"], correct: 0 },
        { q: "Requirement for Discharge Diagnosis in legal docs?", a: ["Physician Sign", "ICD10 code", "Time", "Patient PIN"], correct: 1 },
        { q: "Order that stops further entries in patient chart?", a: ["Discharge Patient", "For Billing Discharge", "Ready for Billing", "Stop All Orders"], correct: 2 },
        { q: "Request type for replacement of busted lights?", a: ["FME-Electrical Engg", "BMED", "Housekeeping", "IT Support"], correct: 0 },
        { q: "Document automatically printed after discharge Clearing?", a: ["Pharmacy Slip", "GATE PASS", "Billing Statement", "Clinical Summary"], correct: 1 }
    ];

    window.addEventListener('keydown', e => keys[e.code] = true);
    window.addEventListener('keyup', e => keys[e.code] = false);

    function showScreen(screenId) {
        document.querySelectorAll('#mainOverlay > div').forEach(div => div.style.display = 'none');
        document.getElementById(screenId).style.display = 'flex';
    }

    function validateDetails() {
        if (!document.getElementById('playerNum').value) { alert("Enter numeric Player Number"); return; }
        document.getElementById('displaySite').innerText = document.getElementById('playerSite').value;
        showScreen('screenBriefing');
    }

    function startMission() {
        mainOverlay.style.display = 'none';
        isPaused = false; gameStarted = true; launchAnimation = true;
        ambulance.y = 600; 
    }

    function triggerCheckpoint() {
        inQuiz = true; isPaused = true;
        mainOverlay.style.display = 'flex';
        showScreen('screenQuiz');
        document.getElementById('wrongFeedback').style.display = 'none';
        showQuestion();
    }

    function showQuestion() {
        const q = questions[currentQuestionIndex];
        document.getElementById('qText').innerText = q.q;
        const container = document.getElementById('optionsContainer');
        container.innerHTML = '';
        q.a.forEach((opt, i) => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerText = (i+1) + ". " + opt;
            btn.onclick = () => handleAnswer(i);
            container.appendChild(btn);
        });
    }

    function handleAnswer(idx) {
        if (idx === questions[currentQuestionIndex].correct) {
            currentQuestionIndex++;
            qCorrectText.innerText = currentQuestionIndex;
            document.getElementById('wrongFeedback').style.display = 'none';
            if (currentQuestionIndex % 5 !== 0 && currentQuestionIndex < 30) showQuestion();
            else resumeGame();
        } else {
            distance = Math.max(0, distance - 250); 
            document.getElementById('wrongFeedback').style.display = 'block';
        }
    }

    function resumeGame() {
        inQuiz = false; isPaused = false;
        mainOverlay.style.display = 'none';
        if (currentQuestionIndex >= 30) arriving = true;
        else distance += 10; 
    }

    function drawCar(car) {
        ctx.fillStyle = car.color; ctx.fillRect(car.x, car.y, car.w, car.h);
        ctx.fillStyle = '#333'; ctx.fillRect(car.x+6, car.y+12, car.w-12, 8); 
        ctx.fillRect(car.x+6, car.y+car.h-18, car.w-12, 6); 
    }

    function update() {
        if (isPaused || !gameStarted || inQuiz) return;
        
        if (launchAnimation) {
            ambulance.y -= 5; roadOffset += 15;
            if (ambulance.y <= 450) launchAnimation = false;
            return;
        }

        if (arriving) {
            hospitalY += 3; roadOffset += 5;
            if (hospitalY >= 100) {
                ambulance.y -= 2;
                if (ambulance.y <= 280) {
                    isPaused = true;
                    ctx.fillStyle = 'rgba(0,0,0,0.85)';
                    ctx.fillRect(0, 200, canvas.width, 150);
                    ctx.fillStyle = '#00ff88'; ctx.font = 'bold 24px sans-serif'; ctx.textAlign = 'center';
                    ctx.fillText("MISSION ACCOMPLISHED!", 180, 260);
                    ctx.fillStyle = '#fff'; ctx.font = '16px sans-serif';
                    ctx.fillText("St. Luke's Thanks You!", 180, 300);
                }
            }
        } else {
            distance += 2; roadOffset += 10;
            if (invincibilityFrames > 0) invincibilityFrames--;
            
            if (distance >= 1000 && currentQuestionIndex < 5) triggerCheckpoint();
            if (distance >= 2000 && currentQuestionIndex < 10) triggerCheckpoint();
            if (distance >= 3000 && currentQuestionIndex < 15) triggerCheckpoint();
            if (distance >= 4000 && currentQuestionIndex < 20) triggerCheckpoint();
            if (distance >= 5000 && currentQuestionIndex < 25) triggerCheckpoint();
            if (distance >= 6000 && currentQuestionIndex < 30) triggerCheckpoint();

            if (keys['ArrowLeft'] && ambulance.x > 10) ambulance.x -= ambulance.speed;
            if (keys['ArrowRight'] && ambulance.x < canvas.width - ambulance.w - 10) ambulance.x += ambulance.speed;

            spawnTimer++;
            if (spawnTimer > 30) {
                traffic.push({ x: Math.random()*(canvas.width-40), y: -100, w: 36, h: 68, speed: 4 + Math.random()*4, color: '#e67e22' });
                spawnTimer = 0;
            }

            for (let i = traffic.length-1; i >= 0; i--) {
                traffic[i].y += traffic[i].speed;
                if (invincibilityFrames === 0 && ambulance.x < traffic[i].x + traffic[i].w && ambulance.x + ambulance.w > traffic[i].x && ambulance.y < traffic[i].y + traffic[i].h && ambulance.y + ambulance.h > traffic[i].y) {
                    distance = Math.max(0, distance - 100);
                    invincibilityFrames = 60; 
                }
                if (traffic[i].y > canvas.height) traffic.splice(i, 1);
            }
        }
        distText.innerText = Math.floor(distance);
        progBar.style.width = (currentQuestionIndex / 30 * 100) + "%";
    }

    function draw() {
        ctx.clearRect(0,0, canvas.width, canvas.height);
        ctx.fillStyle = '#222'; ctx.fillRect(0,0, canvas.width, canvas.height);
        ctx.strokeStyle = '#f1c40f'; ctx.setLineDash([40, 40]); ctx.lineDashOffset = -roadOffset; ctx.lineWidth = 6;
        ctx.beginPath(); ctx.moveTo(canvas.width/2, 0); ctx.lineTo(canvas.width/2, canvas.height); ctx.stroke();

        if (arriving) {
            ctx.fillStyle = '#ddd'; ctx.fillRect(40, hospitalY, 280, 200);
            ctx.fillStyle = '#ff3e3e'; ctx.font = 'bold 50px sans-serif'; ctx.textAlign = 'center'; ctx.fillText("‚úö", 180, hospitalY + 90);
        }

        if (invincibilityFrames % 10 < 5) {
            ctx.fillStyle = '#fff'; ctx.fillRect(ambulance.x, ambulance.y, ambulance.w, ambulance.h);
            ctx.fillStyle = '#ff3e3e'; ctx.fillRect(ambulance.x, ambulance.y + 25, ambulance.w, 10);
            let lightColor = (Math.floor(Date.now()/150)%2) ? '#ff3e3e' : '#00d4ff';
            ctx.fillStyle = lightColor; ctx.fillRect(ambulance.x + 8, ambulance.y - 6, 20, 7);
        }
        if (!arriving) traffic.forEach(drawCar);
        requestAnimationFrame(draw);
    }
    setInterval(update, 1000/60);
    draw();
</script>
</body>
</html>
