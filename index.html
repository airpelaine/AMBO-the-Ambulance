<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AMBO - Automated Module-Based Outcome</title>
    <style>
        :root {
            --primary-blue: #00d4ff;
            --emergency-red: #ff3e3e;
            --warning-gold: #ffcc00;
            --success-green: #27ae60;
            --bg-dark: #0f0f0f;
        }

        body { 
            display: flex; justify-content: center; align-items: flex-start; 
            height: 100vh; margin: 0; background: var(--bg-dark); 
            font-family: 'Segoe UI', Roboto, sans-serif; color: white; overflow: hidden;
            touch-action: none; padding-top: 15px;
        }

        .container { 
            position: relative; display: flex; flex-direction: column; align-items: center; 
            width: 100%; max-width: 420px; margin-top: 60px;
        }

        canvas { 
            background: #1a1a1a; border: 3px solid #333; border-radius: 16px; 
            width: 92%; height: auto; box-shadow: 0 0 40px rgba(0,212,255,0.15); 
        }
        
        .hud-header-tag { 
            position: absolute; top: -50px; left: 4%; right: 4%;
            display: flex; justify-content: space-between; align-items: center;
            font-size: 11px; color: #fff; background: rgba(30, 30, 30, 0.9); 
            padding: 8px 12px; border-radius: 8px; border: 1px solid #444;
            letter-spacing: 1px;
        }

        .stats-bar {
            width: 92%; display: flex; justify-content: space-between;
            margin-bottom: 8px; font-size: 12px; font-weight: bold;
        }
        .stat-item { display: flex; align-items: center; gap: 4px; }
        .stat-red { color: var(--emergency-red); }
        .stat-blue { color: var(--primary-blue); }

        #mainOverlay {
            position: absolute; top: 0px; left: 4%; right: 4%; bottom: 80px;
            background: rgba(10, 10, 10, 0.96); border: 2px solid var(--primary-blue); border-radius: 20px;
            display: flex; flex-direction: column; padding: 20px; z-index: 100;
            backdrop-filter: blur(8px);
        }

        .story-header { font-size: 18px; color: var(--emergency-red); font-weight: 900; text-align: center; margin-bottom: 10px; text-transform: uppercase; }
        .story-text { 
            font-size: 13px; color: #eee; margin-bottom: 15px; line-height: 1.5; 
            text-align: center; background: rgba(255,255,255,0.05); padding: 15px; 
            border-radius: 12px; border-left: 4px solid var(--primary-blue); min-height: 80px;
        }
        
        .option-btn { 
            background: #252525; text-align: left; margin-bottom: 8px; padding: 12px; 
            border-radius: 10px; font-size: 12px; border: 1px solid #444; width: 100%; color: white;
            cursor: pointer;
        }
        .option-btn:hover { background: #333; }
        
        #feedbackMsg { font-weight: bold; text-align: center; margin-bottom: 10px; font-size: 16px; display: none; padding: 8px; border-radius: 8px; }
        .correct { color: var(--success-green); background: rgba(39, 174, 96, 0.1); }
        .wrong { color: var(--emergency-red); background: rgba(255, 62, 62, 0.1); }

        .form-group { margin-bottom: 12px; text-align: left; width: 100%; }
        .form-group label { display: block; font-size: 10px; color: var(--primary-blue); margin-bottom: 5px; text-transform: uppercase; }
        .form-group input, .form-group select { 
            width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #444; 
            background: #111; color: white; box-sizing: border-box; font-size: 14px;
        }

        .ambo-avatar { width: 50px; height: 80px; margin: 0 auto 15px; position: relative; background: #fff; border-radius: 4px; border: 2px solid #ccc; }
        .ambo-avatar::after { content: ''; position: absolute; top: 35px; left: 0; width: 100%; height: 12px; background: var(--emergency-red); }
        .siren-light {
            position: absolute; top: -8px; left: 50%; transform: translateX(-50%);
            width: 34px; height: 8px; border-radius: 4px;
            animation: flickerSiren 0.3s infinite alternate;
        }
        @keyframes flickerSiren {
            0% { background: var(--emergency-red); box-shadow: 0 0 15px var(--emergency-red); }
            100% { background: var(--primary-blue); box-shadow: 0 0 15px var(--primary-blue); }
        }

        .progress-container { width: 92%; height: 8px; background: #222; border-radius: 10px; margin-top: 15px; border: 1px solid #333; overflow: hidden; }
        #progressBar { width: 0%; height: 100%; background: linear-gradient(90deg, var(--primary-blue), #00ff88); transition: width 0.4s ease; }
        
        .game-btn { padding: 16px 24px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; color: white; text-transform: uppercase; letter-spacing: 1px; }
        .btn-green { background: var(--success-green); width: 100%; margin-top: 10px; box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3); }
        .reset-btn { background: none; border: none; color: #666; margin-top: 10px; font-size: 11px; cursor: pointer; text-decoration: underline; font-weight: bold; }
        
        .result-data-box {
            background: rgba(255,255,255,0.05); border: 1px solid #333; border-radius: 12px;
            padding: 15px; margin: 15px 0; width: 85%;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="hud-header-tag">
        <span id="hudModuleTitle">CLINICAL SERVICES</span>
        <span id="hudPlayerID">ID: ---</span>
    </div>

    <div class="stats-bar">
        <div class="stat-item stat-red">üíì STABILITY: <span id="stabilityDisplay">100</span>%</div>
        <div class="stat-item stat-blue">üèÅ <span id="dist">0</span>m</div>
    </div>
    
    <canvas id="game" width="360" height="580"></canvas>
    
    <div id="mainOverlay">
        <div id="screenStart" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center;">
            <div class="ambo-avatar"><div class="siren-light"></div></div>
            <h1 style="margin: 0; color: #fff; font-size: 28px;">üöë AMBO</h1>
            <p style="color: var(--warning-gold); font-size: 11px; letter-spacing: 1px; margin-bottom: 30px;">Automated Module-Based Outcome for NTCP</p>
            <button class="game-btn btn-green" onclick="showScreen('screenDetails')">START MISSION</button>
        </div>

        <div id="screenDetails" style="display: none; flex-direction: column; justify-content: center; height: 100%;">
            <div class="story-header">DEPLOYMENT</div>
            <div class="form-group">
                <label>Training Module</label>
                <select id="trainingModule">
                    <option value="emergency">Emergency Care</option>
                    <option value="ambulatory">Ambulatory Care</option>
                    <option value="basic">Basic Navigation</option>
                    <option value="acute">Acute/Surgical Care</option>
                </select>
            </div>
            <div class="form-group">
                <label>Assigned Site</label>
                <select id="playerSite">
                    <option value="Quezon City">St. Luke's - Quezon City</option>
                    <option value="Global City">St. Luke's - Global City</option>
                </select>
            </div>
            <div class="form-group">
                <label>Player Number</label>
                <input type="number" id="playerNum" inputmode="numeric" placeholder="Enter employee number">
            </div>
            <button class="game-btn btn-green" onclick="validateDetails()">CONFIRM DISPATCH</button>
        </div>

        <div id="screenBriefing" style="display: none; flex-direction: column; justify-content: center; height: 100%;">
            <div class="ambo-avatar"><div class="siren-light"></div></div>
            <div class="story-header">üö® MISSION BRIEFING üö®</div>
            <div id="storyContent" class="story-text"></div>
            <button id="storyBtn" class="game-btn btn-green" onclick="nextStory()">CONTINUE</button>
        </div>

        <div id="screenQuiz" style="display: none; flex-direction: column; justify-content: center; height: 100%;">
            <div id="feedbackMsg"></div>
            <div id="qText" style="font-size: 14px; margin-bottom: 10px; font-weight: bold; line-height: 1.4;"></div>
            <div id="optionsContainer"></div>
        </div>

        <div id="screenResult" style="display: none; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center;">
            <div class="story-header" style="color: var(--success-green); font-size: 22px;">MISSION ACCOMPLISHED!</div>
            
            <div class="result-data-box">
                <div id="finalPlayerDisplay" style="color: var(--primary-blue); font-size: 16px; font-weight: bold; margin-bottom: 10px;">ID: ---</div>
                <div style="display: flex; justify-content: space-around;">
                    <div>
                        <div id="finalStability" style="font-size: 32px; font-weight: bold; color: #fff;">100%</div>
                        <p style="font-size: 9px; color: #aaa; margin:0;">STABILITY</p>
                    </div>
                    <div>
                        <div id="finalSync" style="font-size: 32px; font-weight: bold; color: var(--warning-gold);">0/0</div>
                        <p style="font-size: 9px; color: #aaa; margin:0;">SYSTEM SYNC</p>
                    </div>
                </div>
            </div>

            <p style="font-size: 11px; color: #888; margin-bottom: 15px; width: 80%;">Click below to validate your credentials and generate your sync token.</p>
            
            <div id="generatedCodeDisplay" style="background: #222; padding: 12px; border-radius: 8px; font-family: monospace; color: var(--primary-blue); font-size: 13px; margin-bottom: 15px; display: none; width: 85%; border: 1px solid #444; word-break: break-all;"></div>
            
            <button id="genBtn" class="game-btn btn-green" onclick="processValidation()">VALIDATE & SYNC</button>
        </div>
    </div>

    <div class="progress-container"><div id="progressBar"></div></div>
    <button class="reset-btn" onclick="location.reload()">RESET SIMULATION</button>
</div>

<script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const distText = document.getElementById('dist'), 
          stabText = document.getElementById('stabilityDisplay'),
          hudPlayerID = document.getElementById('hudPlayerID'),
          hudModuleTitle = document.getElementById('hudModuleTitle'),
          progBar = document.getElementById('progressBar'), 
          mainOverlay = document.getElementById('mainOverlay'), 
          feedbackMsg = document.getElementById('feedbackMsg');

    let distance = 0, stability = 100, currentQuestionIndex = 0, syncScore = 0;
    let isPaused = true, inQuiz = false, gameStarted = false, arriving = false;
    let roadOffset = 0, spawnTimer = 0, batchCount = 0, hospitalY = -600;
    let nextMilestone = 1000, firstAttemptAtThisQuestion = true;
    let playerIDValue = "";
    let currentQuestionSet = [];

    const ambulance = { x: 162, y: 480, w: 36, h: 70, speed: 7 };
    let traffic = [];
    const keys = {};

    window.addEventListener('keydown', e => keys[e.code] = true);
    window.addEventListener('keyup', e => keys[e.code] = false);

    function getBriefingText() {
        return [
            `"System online. Connection established. <b>Hello, Pilot ${playerIDValue}!</b> I am AMBO, your Automated Module-Based Outcome unit."`,
            `"The <b>Online Clinical Information System (O-CIS)</b> is under heavy load. We must deliver patient data safely."`,
            `"<b>The Sync Standard:</b> Only the <b>first answer</b> you choose counts toward your System Sync score. Mistakes deduct stability."`,
            `"Your final <b>Stability</b> is calculated as your accuracy rate. Ready to deploy?"`
        ];
    }

    const allQuestions = {
        emergency: [
            { q: "What is the full name of the O-CIS system?", a: ["Offline Clinical Integrated Software", "Optimal Care Information System", "Online Clinical Information System", "Organized Clinical Input System"], correct: 2 },
            { q: "What is the correct format for an O-CIS username?", a: ["Full Last Name + First Name Initial", "First Name + Middle Initial + Last Name", "Employee ID Number", "Initials of First Name/s + Middle Initial + Full Last Name"], correct: 3 },
            { q: "Which keyboard shortcut is used to quickly lock a computer screen for security?", a: ["Alt + F4", "Ctrl + Shift + Esc", "Windows key + L", "Alt + Tab"], correct: 2 },
            { q: "On the Tracking Board, what does a 'Lab' icon with a white background with pencil signify?", a: ["Results are final", "The Lab order is pending collection", "Specimen received", "Order cancelled"], correct: 1 },
            { q: "Which dashboard icon indicates that microbiology order status is unreviewed results?", a: ["Micb with a blue checkmark", "Micb with a gray circle", "Micb with a red exclamation mark (!)", "Micb with a blue letter 'i'"], correct: 0 },
            { q: "What does the 'e12' icon represent?", a: ["12 resources needed", "Room 12e", "Delayed 12h", "Previous ED visit within last 12h"], correct: 3 },
            { q: "In the Worklist Manager, what color do medication tasks turn when they are 60 mins past due?", a: ["Yellow", "Orange", "Red", "Purple"], correct: 2 },
            { q: "In Registration, If a patient has no middle name, enter:", a: ["N/A", "None", "A Dash (-)", "Leave blank"], correct: 2 },
            { q: "Which application is used to update the patient's 'Account Class' (HMO/Individual)?", a: ["O-CIS Toolbar", "St. Luke‚Äôs Billing (SLB)", "Patient Flow", "Citrix"], correct: 1 },
            { q: "Which ESI Level is assigned to a patient requiring 'immediate life-saving intervention'?", a: ["ESI Level 1", "ESI Level 2", "ESI Level 3", "ESI Level 5"], correct: 0 },
            { q: "Under ESI guidelines, how many 'resources' for labs and an X-ray?", a: ["One", "Two", "Three", "Zero"], correct: 1 },
            { q: "What does the acronym ROE stand for during a system downtime?", a: ["Recovery Engine", "Read Only Environment", "Remote Output", "Real-time Entry"], correct: 1 },
            { q: "System downtime: ROE pulls flowsheet data from the past how many hours?", a: ["12 hours", "24 hours", "48 hours", "72 hours"], correct: 2 },
            { q: "Which manual form is used for doctors' progress notes and orders during downtime?", a: ["Triage Form", "Nurses' Notes", "DPNOS", "Patient Information Sheet"], correct: 2 },
            { q: "What must be done with manual paper forms once system is back online?", a: ["Shredded", "Re-entered manually", "Scanned into Opal", "Filed in binder"], correct: 2 },
            { q: "In the Patient Flow application, what does status code 'RACK' stand for?", a: ["Request Active", "Room Assigned", "Acknowledged", "Recovery Area Check"], correct: 2 },
            { q: "To claim CSS items in SLB, how many printed copies are required?", a: ["One", "Two", "Three", "Four"], correct: 1 },
            { q: "Which specific fall risk assessment tool is used for pediatric patients?", a: ["Morse Fall Risk", "Humpty Dumpty Fall Risk", "General Assessment", "Prevention Agreement"], correct: 1 },
            { q: "At what age is a patient automatically high risk for falls under Morse tool?", a: ["55 and above", "60 and above", "65 and above", "70 and above"], correct: 2 },
            { q: "What document is required for a patient to leave the ER once bill is settled?", a: ["Final Receipt", "Gate pass", "Signed Waiver", "Medical Certificate"], correct: 1 },
            { q: "Which O-CIS toolbar button locks application for a short period?", a: ["Shutdown", "Suspend", "User Preferences", "Help"], correct: 1 },
            { q: "Nurse checks what in SLB during discharge to ensure charges clear?", a: ["Triage Priority", "Room Assignment", "Invalid and Pending Transactions", "Demographics"], correct: 2 },
            { q: "Who enters the Disposition Note in OCIS?", a: ["MD and CP", "MD only", "MD and RN", "RN and CP"], correct: 2 },
            { q: "Upon endorsement, who will tag the patients to the incoming nurse?", a: ["Outgoing nurse", "Incoming nurse", "Charge nurse", "Outgoing charge nurse"], correct: 0 },
            { q: "In 'Enter Document', what does a 'Significant Field' (Blue Asterisk) indicate?", a: ["Cannot save until filled", "Can save, but will be tagged as Incomplete", "Mandatory field", "Physician signature required"], correct: 1 },
            { q: "How many clinicians are required to verify blood products before transfusion?", a: ["One", "Two", "Three", "Four"], correct: 1 },
            { q: "In the Emergency Department Process Flow, what is Step 1?", a: ["Vital Signs", "Room Assignment", "Registration at Triage Area", "Laboratory Tests"], correct: 2 },
            { q: "What is the name of the automated dispensing cabinet for medications?", a: ["Zebra", "Topaz", "Omnicell", "Fujitsu"], correct: 2 },
            { q: "Which device is specifically used for signing electronic document files?", a: ["Specimen Printer", "Fujitsu Scanner", "Topaz E-Signature Pad", "Barcode Scanner"], correct: 2 },
            { q: "Manual form used to procure items from Pharmacy or CSS during downtime:", a: ["Doctor‚Äôs Order Sheet", "Patient Account Charge (PAC)", "Medical Certificate", "Triage Form"], correct: 1 }
        ],
        ambulatory: [
            { q: "Software required to launch O-CIS environment?", a: ["Adobe Reader", "Google Chrome", "Citrix Workspace/Receiver", "Edge"], correct: 2 },
            { q: "Portal address used to access O-CIS system?", a: ["ocis.stlukes.com.ph", "portal.stlukes.com.ph", "stlukes.citrix.com", "emr.stlukes.ph"], correct: 1 },
            { q: "Gateway icon used to 'Suspend' or lock app?", a: ["Red power", "Green question", "Purple crescent moon", "Blue eyeglasses"], correct: 2 },
            { q: "Toolbar icon to Shutdown (exit/close) Sunrise?", a: ["Suspend", "Red power button", "User Preferences", "Recently Viewed"], correct: 1 },
            { q: "Where to set default Sunrise app for startup?", a: ["Main Toolbar", "Chart Level", "User Preferences (General Tab)", "Citrix Storefront"], correct: 2 },
            { q: "Information used to search patient in 'Find Visit'?", a: ["Last Name", "MRN", "Visit Number", "All of the above"], correct: 3 },
            { q: "Why ask if patient has existing PIN during registration?", a: ["Check billing", "To avoid double MRN", "Verify insurance", "Check allergies"], correct: 1 },
            { q: "Standard text format for patient names in registration?", a: ["Sentence case", "ALL CAPS (CAPS LOCK)", "lowercase", "Title Case"], correct: 1 },
            { q: "Missing middle name in registration protocol?", a: ["Leave blank", "Put N/A", "Put a DASH (-)", "Type NONE"], correct: 2 },
            { q: "Function to document physical arrival of patient to ANS unit?", a: ["Register Now", "Pre-Reg", "Arrive/Cancel Arrival", "Change Location"], correct: 2 },
            { q: "Trigger order to initiate payment processing in SLB?", a: ["Discharge Order", "Pharmacy Order", "Ready for Billing", "Lab Order"], correct: 2 },
            { q: "Current Providers radio button represents?", a: ["Nurse entering", "Attending and Referral MDs", "Fellows/Residents", "Billing Dept"], correct: 1 },
            { q: "Field used to manually modify the title of a document?", a: ["Document Name", "Document Topic", "Sections", "Source"], correct: 1 },
            { q: "Left 'Significant' field blank means?", a: ["Cannot save", "Document can only be saved as 'Incomplete'", "Fills N/A", "Prevents logoff"], correct: 1 },
            { q: "Function to copy details from previous notes?", a: ["Refer to Note", "Modify Template", "Copy Forward", "Expansion"], correct: 2 },
            { q: "Knowledge Based Medication Administration (KBMA) purpose?", a: ["Drug cost", "Use patient/med barcodes to validate", "Print labels", "Order meds"], correct: 1 },
            { q: "First two steps in KBMA workflow?", a: ["Scan drug then patient", "Scan patient barcode then medication barcode", "Check ID then ask name", "Open MAR then scan drug"], correct: 1 },
            { q: "Worklist Manager: color RED indicates task is?", a: ["Continuous", "Scheduled", "Overdue (60 mins past due)", "PRN"], correct: 2 },
            { q: "Validation requirement for High Alert Medications (HAM)?", a: ["MD signature", "A Witness or Co-Signature", "Verbal consent", "Pharmacy approval"], correct: 1 },
            { q: "Action for 'No Match on Scan' error?", a: ["Administer anyway", "Discard initial scan and re-verify", "Override", "Type name"], correct: 1 },
            { q: "Add flowsheet not visible in selection?", a: ["Add Parameter", "Click the '+' (Plus) icon", "Main Toolbar", "Right-click"], correct: 1 },
            { q: "Assessment tool for patient risk for falling?", a: ["NIHSS", "Morse Fall Scale", "GCS", "Braden"], correct: 1 },
            { q: "MD Allergy Review window (Inpatients)?", a: ["2 hours", "4 hours", "8 hours", "24 hours"], correct: 2 },
            { q: "Result if allergies NOT reviewed by MD within 8h?", a: ["Auto-discharge", "Entering of orders will not be allowed", "Billing notified", "Nurse re-enters"], correct: 1 },
            { q: "Icon in EMR signifying abnormal laboratory result?", a: ["Red exclamation", "Red Flag", "Green Flag", "Yellow Flag"], correct: 3 },
            { q: "Environment providing 'Read-Only' access during downtime?", a: ["PROD", "ROE", "TRAIN", "TEST"], correct: 1 },
            { q: "Tab to view scanned loose documents/prescriptions?", a: ["Results", "Flowsheets", "Document Management", "Timeline"], correct: 2 },
            { q: "Policy placement for 'SCANNED' stamp on physical documents?", a: ["Top right", "Center", "Left lower portion", "Back"], correct: 2 },
            { q: "Paper form for multidisciplinary assessment during downtime?", a: ["Admission Note", "MIAD", "Order Entry", "Case Usage"], correct: 1 },
            { q: "Accessing St. Luke's Billing (SLB) system?", a: ["OCIS Toolbar", "Gateway", "SLMC Enterprise Portal login", "Signature pad"], correct: 2 }
        ],
        basic: [
            { q: "O-CIS system portal address?", a: ["ocis.stlukes.com.ph", "portal.stlukes.com.ph", "stlukes.citrix.com", "emr.stlukes.ph"], correct: 1 },
            { q: "App to launch O-CIS environment?", a: ["Adobe", "Chrome", "Citrix Workspace/Receiver", "Edge"], correct: 2 },
            { q: "Contact for missing Chrome/Citrix on device?", a: ["Unit Manager", "HR", "IT (local 4206/5520)", "HCA"], correct: 2 },
            { q: "Credentials for St. Luke's Enterprise Portal?", a: ["Employee ID", "Personal email", "Domain account", "Citrix key"], correct: 2 },
            { q: "Add app to 'Favorites' in Citrix by?", a: ["Right-click", "Highlight the star", "Drag icon", "Contact IT"], correct: 1 },
            { q: "NOT a core value of SLMC?", a: ["Integrity", "Profitability", "Accountability", "Teamwork"], correct: 1 },
            { q: "Gateway Toolbar icon for 'Suspend' (short lock)?", a: ["Red power", "Green question", "Purple crescent moon", "Blue eyeglasses"], correct: 2 },
            { q: "Gateway icon for 'Shutdown'?", a: ["Suspend", "Red power button", "Preferences", "eyeglasses"], correct: 1 },
            { q: "Set default startup application in?", a: ["Main Toolbar", "Chart Level", "User Preferences Settings (General Tab)", "Citrix Storefront"], correct: 2 },
            { q: "Recently Viewed Patient (Eyeglasses) icon shows?", a: ["Insurance", "Recently viewed patient at 'By Patient' tab", "Lab results", "Shift summary"], correct: 1 },
            { q: "First step to find specific patient visit?", a: ["Flowsheet", "Double-click 'Find Visit' icon", "Clinical Summary", "Reports"], correct: 1 },
            { q: "Find Visit search criteria includes?", a: ["Last Name", "MRN", "Visit Number", "All of the above"], correct: 3 },
            { q: "Goal of IPSG 1 is to?", a: ["Communication", "Identify Patients Correctly", "Reduce falls", "Prevent infection"], correct: 1 },
            { q: "Patient header details include?", a: ["Age/Gender", "Status", "MRN", "All of the above"], correct: 3 },
            { q: "Header display for patient at risk for fall?", a: ["Strict Bedrest", "Precautions: Fall", "High Alert", "NPO"], correct: 1 },
            { q: "Tab serving as nurse hand-off tool during endorsement?", a: ["Orders", "Results", "Clinical Summary Tab", "Document Management"], correct: 2 },
            { q: "Icon access to Modified Fall Risk Assessment?", a: ["Enter Document", "Enter Order", "Worklist", "Flowsheet"], correct: 0 },
            { q: "Flowsheet Manager assessment tool for fall risk?", a: ["NIHSS", "Morse Fall Scale", "GCS", "Braden"], correct: 1 },
            { q: "CLABSI stands for?", a: ["Laboratory Integration", "Central Line Associated Bloodstream Infection", "Basic System Info", "Life Intervention"], correct: 1 },
            { q: "Flowsheet bundle for patient on artificial airway?", a: ["Fall Prevention", "Intake/Output", "Ventilator-Associated Pneumonia (VAP) Bundle", "Access Devices"], correct: 2 },
            { q: "Location of 'Print Reports' icon?", a: ["Patient Info", "On the Main Toolbar", "Citrix Launcher", "Login screen"], correct: 1 },
            { q: "Report Category to print clinical document?", a: ["Administrative", "Results", "Documents", "Patient Lists"], correct: 2 },
            { q: "Purpose of 'Preview' button in report selection?", a: ["Finalize", "Check the document before printing", "Edit text", "Save PDF"], correct: 1 },
            { q: "Report for PhilHealth claim form?", a: ["CF3 Report", "Transfer Note", "Discharge Summary", "Med Certificate"], correct: 0 },
            { q: "Correct Report Category for laboratory results?", a: ["Documents", "Results", "Orders", "Administrative"], correct: 1 },
            { q: "BCP stands for?", a: ["Basic Care Plan", "Billing Process", "Business Continuity Plan", "Backup Portal"], correct: 2 },
            { q: "Environment for 'Read-Only' downtime access?", a: ["TEST", "ROE", "TRAIN", "SLB-DATA"], correct: 1 },
            { q: "Downtime paper form for Admission Note Nursing?", a: ["Administration", "Multi-Disciplinary Initial Assessment Database", "Monthly Audit", "Inventory"], correct: 1 },
            { q: "Age range for MIAD Pediatric form?", a: ["Birth-28d", "29 Days to 18 years and 364 days old", "19y+", "Over 65y"], correct: 1 },
            { q: "Access St. Luke's Billing (SLB) through?", a: ["OCIS Toolbar", "Gateway", "SLMC Enterprise Portal login", "Google Chrome"], correct: 2 }
        ],
        acute: [
            { q: "Bedside nurse EMR access protocol?", a: ["Pathology COW", "the COW/WOW of the Nursing Unit where I am on duty", "Any unit COW", "Any IT device"], correct: 1 },
            { q: "Submit password SARF to?", a: ["IT USG", "Unit Manager", "HCA", "Data Analytics"], correct: 0 },
            { q: "Color/Symbol for emergency value needing immediate action?", a: ["Green check", "Blue exclamation", "Red exclamation mark", "Green box"], correct: 2 },
            { q: "Green checkmark next to vital sign indicates?", a: ["Danger high", "Normal and verified", "Broken sensor", "Not seen by MD"], correct: 1 },
            { q: "Menu for printing prescriptions?", a: ["Print Reports", "Prescription Writer", "Enter Document", "Enter Order"], correct: 0 },
            { q: "Icon for value out of range but not life-threatening?", a: ["Blue exclamation mark", "Red exclamation", "Green check", "Grey heart"], correct: 0 },
            { q: "Lab status signified by icon with pencil in corner?", a: ["Received", "Critical", "Pending Collection", "Final Reviewed"], correct: 2 },
            { q: "Green refresh/cycle arrow on lab icon signifies?", a: ["The specimen has been collected.", "Results critical", "Pending collection", "Lab received"], correct: 0 },
            { q: "Red refresh arrow on lab icon indicates?", a: ["Results corrected", "Lab received", "Specimen not collected for >29 mins", "Collection complete"], correct: 2 },
            { q: "Blue refresh arrow on lab icon indicates?", a: ["Collected", "Pending", "Critical", "Received by Performing Unit"], correct: 3 },
            { q: "Blue checkmark on lab icon indicates?", a: ["Pending collection", "Final results reviewed or corrected", "Received", "Results critical"], correct: 1 },
            { q: "Red exclamation on tracking board indicates?", a: ["Not collected >24h", "Critical Value", "Received", "Final reviewed"], correct: 1 },
            { q: "Demographic data text format policy?", a: ["ALL CAPS", "Does not matter", "Title Caps", "lowercase"], correct: 0 },
            { q: "No middle name protocol?", a: ["N/A", "-", "NA", "/"], correct: 1 },
            { q: "Inpatient procedure scheduling visit protocol?", a: ["Use 'Admitted/Arrived' visit number", "New visit", "None of above", "PreReg visit number"], correct: 0 },
            { q: "Surgical Case confirmation timeframe?", a: ["Day of", "4h prior", "Week before", "The night prior the procedure"], correct: 3 },
            { q: "Tagging of Surgical Time Markers protocol?", a: ["OR Tech needed", "In real-time", "In PACU", "After procedure"], correct: 1 },
            { q: "Clinical Document NOT entered by nurse?", a: ["PreOp Note", "Admission Note Nursing", "PreOp Nursing Note", "Transfer Note"], correct: 0 },
            { q: "First EMR step for ER Admission arrival?", a: ["Mark worklist done", "Change Temporary Location", "Change Assigned Location to designated room", "Add to visit list"], correct: 2 },
            { q: "Unit view for incoming admissions?", a: ["Personal Visit List", "Pending Incoming Visit List", "Patients Logbook", "Patient Flow"], correct: 1 },
            { q: "Form for admitting 19-year-old patient?", a: ["Pediatric Note", "Admission Note Nursing", "Newborn Note", "Obstetric Note"], correct: 1 },
            { q: "Action to add Home Medications during history interview?", a: ["Prescription Writer", "Order Reconciliation", "Allergies Summary", "Add Item"], correct: 1 },
            { q: "Action to add allergies during history interview?", a: ["Order Reconciliation", "Allergies Summary", "Add Item", "Prescription Writer"], correct: 1 },
            { q: "Infusion Pump worklist tasks marked done?", a: ["Before EOS", "Before midnight", "Every hour", "Once performed"], correct: 1 },
            { q: "Continuous oxygen therapy worklist tasks marked done?", a: ["Every end of shift", "Every midnight", "Every hour", "Start of shift"], correct: 0 },
            { q: "POCT CBG in worklist manager marked done?", a: ["Every shift", "After 8 hours", "Every hour", "When performed"], correct: 3 },
            { q: "Request additional doses for medication wastage via?", a: ["Outpatient Review", "Order Recon", "Prescription Writer", "Order Message Manager"], correct: 3 },
            { q: "Charge Nurse protocol before First Dose check?", a: ["Add comment 'First Dose Checked'", "Mark as done", "Enter Username/PW for check", "Administer"], correct: 0 },
            { q: "Medication rescheduling protocol?", a: ["Charge Nurse instructions", "No need (automated)", "After first dose/outside window", "After each dose"], correct: 2 },
            { q: "Protocol for endorsing remaining multidose vials?", a: ["adding a comment on the medication inside worklist manager", "Comment on flowsheet", "Verbal only", "Clinical document"], correct: 0 },
            { q: "Appendectomy med from general unit uses KBMA (T/F)?", a: ["FALSE", "TRUE"], correct: 1 },
            { q: "Activate Request for Blood Pickup via?", a: ["Worklist", "the Orders Tab", "Enter Order", "KBMA"], correct: 1 },
            { q: "Document for Blood Transfusion reactions?", a: ["Flowsheet", "Assessment and Cares", "Blood Transfusion Reaction Note", "Summary"], correct: 2 },
            { q: "Plan of Care accomplishment frequency?", a: ["Every hour", "Every shift", "every problem occurrence", "As necessary"], correct: 2 },
            { q: "Peri-Op Nurse documentation includes?", a: ["PreOp Nursing Note", "Intra-Op Record", "Surgery Case Details", "All of the Above"], correct: 3 },
            { q: "Listing used procedure equipment in Surgical Case List?", a: ["Post-Op", "Case Usage", "Case Header", "Intra-Op"], correct: 1 },
            { q: "Add new flowsheet in criteria via?", a: ["Enter Document", "Create Referral", "Plus Sign", "Flowsheet Manager"], correct: 2 },
            { q: "Clinical documentation for Critical Values?", a: ["Critical Results Notification", "Value Flowsheet", "Result Summary", "None"], correct: 0 },
            { q: "Physician Order Reconciliation protocol?", a: ["Transfer/Condition Change", "Admission", "Discharge", "All of the above"], correct: 3 },
            { q: "Discharge Order placed by?", a: ["Attending Physician", "Referring Physician", "Co-manage Physician", "All MDs"], correct: 0 },
            { q: "Nurse entry to create Home Instructions?", a: ["Patient Instructions", "Referral Instructions", "Discharge Instructions, Inpatient", "MADPA"], correct: 2 },
            { q: "NOT required prior to payment?", a: ["CF2/CF4", "For Billing Discharge", "Ready for Billing", "Gate Pass", "OR Tech/PARES"], correct: 3 },
            { q: "iPro unavailable BCP for anesthesiologist?", a: ["PARES", "PreOp Note", "PAC", "I/O Sheet"], correct: 0 },
            { q: "Downtime document to request item/med/procedure?", a: ["Credit Memo", "Fee Slip", "Turn-In Slip", "Patient Account Charge"], correct: 2 },
            { q: "NOT retained as paper-based form?", a: ["Discharge Checklist", "CMRN", "Anesthesia Cart Checklist", "None of the above"], correct: 3 }
        ]
    };

    function showScreen(id) {
        ['screenStart', 'screenDetails', 'screenBriefing', 'screenQuiz', 'screenResult'].forEach(s => document.getElementById(s).style.display = 'none');
        document.getElementById(id).style.display = 'flex';
    }

    function validateDetails() {
        const val = document.getElementById('playerNum').value;
        const modKey = document.getElementById('trainingModule').value;
        if (!val) { alert("Enter employee number"); return; }
        playerIDValue = val;
        hudPlayerID.innerText = "ID: " + val;
        hudModuleTitle.innerText = document.getElementById('trainingModule').options[document.getElementById('trainingModule').selectedIndex].text.toUpperCase();
        currentQuestionSet = allQuestions[modKey];
        storyPart = 0; showStoryPart(); showScreen('screenBriefing');
    }

    let storyPart = 0;
    function showStoryPart() {
        const texts = getBriefingText();
        document.getElementById('storyContent').innerHTML = texts[storyPart];
        document.getElementById('storyBtn').innerText = storyPart === texts.length - 1 ? "üöÄ DEPLOY AMBO" : "NEXT";
    }

    function nextStory() {
        const texts = getBriefingText();
        if (storyPart < texts.length - 1) { storyPart++; showStoryPart(); } 
        else { mainOverlay.style.display = 'none'; isPaused = false; gameStarted = true; }
    }

    function triggerCheckpoint() {
        inQuiz = true; isPaused = true; batchCount = 0;
        mainOverlay.style.display = 'flex'; showScreen('screenQuiz'); showQuestion();
    }

    function showQuestion() {
        if (currentQuestionIndex >= currentQuestionSet.length) { arriving = true; resumeGame(); return; }
        firstAttemptAtThisQuestion = true;
        const q = currentQuestionSet[currentQuestionIndex];
        document.getElementById('qText').innerHTML = `<span style="color:var(--primary-blue)">SYSTEM SYNC...</span><br>Q${currentQuestionIndex + 1}: ${q.q}`;
        const container = document.getElementById('optionsContainer'); container.innerHTML = '';
        q.a.forEach((opt, i) => {
            const btn = document.createElement('button'); btn.className = 'option-btn'; btn.innerText = opt;
            btn.onclick = () => handleAnswer(i); container.appendChild(btn);
        });
    }

    // MODIFIED LOGIC: Patient Stability based on first correct answers over total questions
    function handleAnswer(idx) {
        const correct = currentQuestionSet[currentQuestionIndex].correct;
        if (idx === correct) {
            if (firstAttemptAtThisQuestion) {
                syncScore++;
            }
            feedbackMsg.innerText = "‚úì DATA VALIDATED"; feedbackMsg.className = "correct";
            feedbackMsg.style.display = "block";
            
            // Re-calculate Stability based on correct-first-attempts vs total
            stability = Math.round((syncScore / currentQuestionSet.length) * 100);
            stabText.innerText = stability;

            currentQuestionIndex++; batchCount++;
            setTimeout(() => {
                feedbackMsg.style.display = "none";
                if (batchCount < 5 && currentQuestionIndex < currentQuestionSet.length) showQuestion();
                else resumeGame();
            }, 800);
        } else {
            if (firstAttemptAtThisQuestion) {
                firstAttemptAtThisQuestion = false;
                // Stability still updates visually even if they failed the "first try" point
                stability = Math.round((syncScore / currentQuestionSet.length) * 100);
                stabText.innerText = stability;
            }
            feedbackMsg.innerText = "‚úó SYSTEM LOCK: MISMATCH DETECTED"; feedbackMsg.className = "wrong";
            feedbackMsg.style.display = "block";
        }
    }

    function resumeGame() {
        inQuiz = false; isPaused = false; mainOverlay.style.display = 'none';
        nextMilestone += 1000;
        if (currentQuestionIndex >= currentQuestionSet.length) arriving = true;
    }

    function processValidation() {
        const modKey = document.getElementById('trainingModule').value.substring(0,3).toUpperCase();
        const siteKey = document.getElementById('playerSite').value.includes("Quezon") ? "QC" : "GC";
        const randomHex = Math.random().toString(36).substring(2, 6).toUpperCase();
        
        const completionCode = `${modKey}-${stability}-${syncScore}-${playerIDValue}-${randomHex}`;
        
        const display = document.getElementById('generatedCodeDisplay');
        display.innerText = "SYNC TOKEN: " + completionCode;
        display.style.display = 'block';
        
        const btn = document.getElementById('genBtn');
        btn.innerText = "OPEN CLOUD FORM";
        btn.style.background = "#2980b9";
        
        btn.onclick = function() {
            const scriptURL = "https://script.google.com/macros/s/YOUR_APPSCRIPT_URL/exec";
            const params = new URLSearchParams({
                id: playerIDValue,
                stab: stability,
                sync: syncScore,
                mod: modKey,
                code: completionCode
            });
            window.open(`${scriptURL}?${params.toString()}`, '_blank');
        };
    }

    function drawAmbulance() {
        let light = (Math.floor(Date.now()/200)%2) ? '#ff3e3e' : '#00d4ff';
        ctx.fillStyle = light; ctx.fillRect(ambulance.x+6, ambulance.y-6, 24, 6);
        ctx.fillStyle = '#fff'; ctx.fillRect(ambulance.x, ambulance.y, ambulance.w, ambulance.h);
        ctx.fillStyle = '#ff3e3e'; ctx.fillRect(ambulance.x, ambulance.y+35, ambulance.w, 12);
        ctx.fillStyle = '#333'; ctx.fillRect(ambulance.x+4, ambulance.y+8, ambulance.w-8, 20);
    }

    function drawCar(car) {
        ctx.fillStyle = car.color; ctx.fillRect(car.x, car.y, car.w, car.h);
        ctx.fillStyle = '#add8e6'; ctx.fillRect(car.x+4, car.y+8, car.w-8, 12);
        ctx.fillStyle = '#fff'; ctx.fillRect(car.x+4, car.y+car.h-6, 4, 3); ctx.fillRect(car.x+car.w-8, car.y+car.h-6, 4, 3);
    }

    function drawHospital() {
        ctx.fillStyle = '#f0f0f0'; ctx.fillRect(10, hospitalY, 340, 500);
        ctx.fillStyle = '#333'; ctx.fillRect(10, hospitalY, 340, 15);
        ctx.fillStyle = '#004a99'; ctx.font = 'bold 16px sans-serif'; ctx.textAlign = 'center';
        ctx.fillText("ST. LUKE'S MEDICAL CENTER", 180, hospitalY + 45);
        ctx.fillStyle = 'white'; ctx.fillRect(160, hospitalY + 65, 40, 40);
        ctx.fillStyle = 'red'; ctx.fillRect(175, hospitalY + 70, 10, 30); ctx.fillRect(165, hospitalY + 80, 30, 10);
        ctx.fillStyle = '#add8e6';
        for(let r=0; r<5; r++) for(let c=0; c<4; c++) ctx.fillRect(40 + (c*80), hospitalY + 130 + (r*75), 40, 35);
    }

    function update() {
        if (isPaused || !gameStarted || inQuiz) return;
        if (arriving) {
            traffic = [];
            if (hospitalY < 20) {
                hospitalY += 3; roadOffset += 4;
            } else {
                if (ambulance.y > 450) { ambulance.y -= 1.5; } 
                else {
                    isPaused = true;
                    // UPDATED MISSION ACCOMPLISHED DISPLAY
                    document.getElementById('finalStability').innerText = stability + "%";
                    document.getElementById('finalSync').innerText = `${syncScore}/${currentQuestionSet.length}`;
                    document.getElementById('finalPlayerDisplay').innerText = "PLAYER ID: " + playerIDValue;
                    showScreen('screenResult');
                    mainOverlay.style.display = 'flex';
                }
            }
        } else {
            if (keys['ArrowLeft'] && ambulance.x > 15) ambulance.x -= ambulance.speed;
            if (keys['ArrowRight'] && ambulance.x < canvas.width - ambulance.w - 15) ambulance.x += ambulance.speed;
            distance += 4; roadOffset += 12;
            if (distance >= nextMilestone && currentQuestionIndex < currentQuestionSet.length) triggerCheckpoint();
            spawnTimer++;
            if (spawnTimer > 40) {
                const colors = ['#f39c12', '#8e44ad', '#27ae60', '#d35400'];
                traffic.push({ x: Math.random()*(canvas.width-50) + 10, y: -100, w: 34, h: 65, speed: 5 + Math.random()*2, color: colors[Math.floor(Math.random()*4)] });
                spawnTimer = 0;
            }
            for (let i = traffic.length-1; i >= 0; i--) {
                traffic[i].y += traffic[i].speed;
                if (ambulance.x < traffic[i].x + traffic[i].w && ambulance.x + ambulance.w > traffic[i].x && ambulance.y < traffic[i].y + traffic[i].h && ambulance.y + ambulance.h > traffic[i].y) {
                    distance = Math.max(0, distance - 100); traffic.splice(i, 1);
                } else if (traffic[i].y > canvas.height) traffic.splice(i, 1);
            }
        }
        distText.innerText = Math.floor(distance);
        progBar.style.width = (currentQuestionIndex / currentQuestionSet.length * 100) + "%";
    }

    function draw() {
        ctx.clearRect(0,0, canvas.width, canvas.height); ctx.fillStyle = '#222'; ctx.fillRect(0,0, canvas.width, canvas.height);
        ctx.strokeStyle = '#f1c40f'; ctx.setLineDash([40, 40]); ctx.lineDashOffset = -roadOffset; ctx.lineWidth = 4;
        ctx.beginPath(); ctx.moveTo(canvas.width/2, 0); ctx.lineTo(canvas.width/2, canvas.height); ctx.stroke();
        if (arriving) drawHospital();
        traffic.forEach(drawCar); drawAmbulance();
        requestAnimationFrame(draw);
    }
    setInterval(update, 1000/60); draw();
</script>
</body>
</html>
