<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { 
            display: flex; justify-content: center; align-items: center; 
            height: 100vh; margin: 0; background: #0f0f0f; 
            font-family: 'Segoe UI', sans-serif; color: white; overflow: hidden;
            touch-action: none;
        }
        .container { position: relative; display: flex; flex-direction: column; align-items: center; width: 100%; max-width: 400px; }
        canvas { background: #222; border: 4px solid #444; border-radius: 12px; width: 95%; height: auto; box-shadow: 0 0 30px rgba(0,212,255,0.3); cursor: grab; }
        
        .hud-top-left { position: absolute; top: -60px; left: 10px; font-size: 11px; color: #ff3e3e; font-weight: bold; }
        .hud-top-center { position: absolute; top: -60px; left: 50%; transform: translateX(-50%); font-size: 11px; color: #ffcc00; font-weight: bold; }
        .hud-top-right { position: absolute; top: -60px; right: 10px; font-size: 11px; color: #00d4ff; font-weight: bold; }
        
        .hud-header-tag { 
            position: absolute; top: -38px; left: 10px; right: 10px;
            display: flex; justify-content: space-between; align-items: center;
            font-size: 10px; color: #fff; background: rgba(51, 51, 51, 0.9); 
            padding: 4px 10px; border-radius: 6px; border: 1px solid #555;
            text-transform: uppercase;
        }

        #mainOverlay {
            position: absolute; top: 10px; left: 10px; right: 10px; bottom: 60px;
            background: rgba(5, 5, 5, 0.98); border: 3px solid #00d4ff; border-radius: 15px;
            display: flex; flex-direction: column; padding: 15px; z-index: 100; box-shadow: 0 0 50px rgba(0,0,0,1);
        }
        .story-header { font-size: 20px; color: #ff3e3e; font-weight: 900; text-align: center; margin-bottom: 8px; text-transform: uppercase; }
        .story-text { font-size: 14px; font-style: italic; color: #ddd; margin-bottom: 12px; line-height: 1.4; text-align: center; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; border-left: 4px solid #00d4ff; min-height: 80px; }
        
        .question-text { font-size: 14px; margin-bottom: 10px; line-height: 1.3; color: #fff; font-weight: bold; border-bottom: 1px solid #333; padding-bottom: 8px; }
        .option-btn { 
            background: #2a2a2a; text-align: left; margin-bottom: 6px; padding: 12px; 
            border-radius: 8px; font-size: 13px; border: 1px solid #444; width: 100%; color: white;
            transition: 0.2s; cursor: pointer; -webkit-tap-highlight-color: transparent;
        }
        .option-btn:hover { background: #3a3a3a; border-color: #00d4ff; }
        
        #feedbackMsg { font-weight: bold; text-align: center; margin-bottom: 10px; font-size: 16px; display: none; }
        .correct { color: #27ae60; }
        .wrong { color: #ff3e3e; }

        .form-group { margin-bottom: 10px; text-align: left; width: 100%; }
        .form-group label { display: block; font-size: 11px; color: #00d4ff; margin-bottom: 3px; font-weight: bold; }
        .form-group input, .form-group select { 
            width: 100%; padding: 12px; border-radius: 5px; border: 1px solid #444; 
            background: #1a1a1a; color: white; box-sizing: border-box; font-size: 16px;
        }

        .ambo-avatar { width: 60px; height: 100px; margin: 0 auto 10px auto; background: #fff; border-radius: 5px; position: relative; border: 2px solid #ddd; }
        .ambo-stripe { width: 100%; height: 15px; background: #ff3e3e; position: absolute; top: 40px; }
        .ambo-light { width: 30px; height: 8px; position: absolute; top: -10px; left: 15px; border-radius: 4px; animation: flash 0.3s infinite; }
        @keyframes flash { 0% { background: #ff3e3e; } 50% { background: #00d4ff; } 100% { background: #ff3e3e; } }

        .progress-container { width: 90%; height: 10px; background: #333; border-radius: 10px; margin-top: 15px; border: 2px solid #444; position: relative; }
        #progressBar { width: 0%; height: 100%; background: linear-gradient(90deg, #00d4ff, #00ff88); transition: 0.4s; }
        
        .game-btn { padding: 15px 20px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: white; text-transform: uppercase; font-size: 14px; }
        .btn-green { background: #27ae60; width: 100%; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div class="hud-header-tag">
        <span>Emergency Care Services</span>
        <span>UNIT: <span id="hudPlayerID">---</span></span>
    </div>
    <div class="hud-top-left">‚ùå ERRORS: <span id="qErrors">0</span></div>
    <div class="hud-top-center">üí• CRASHES: <span id="crashCount">0</span></div>
    <div class="hud-top-right">üõ£Ô∏è <span id="dist">0</span>m</div>
    
    <canvas id="game" width="360" height="550"></canvas>
    
    <div id="mainOverlay">
        <div id="screenStart" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%;">
            <div class="story-header" style="font-size: 28px; color: #fff;">üöë AMBO the Ambulance</div>
            <div style="font-size: 12px; color: #ffcc00; font-weight: bold; text-align: center; margin-bottom: 20px;">for Emergency Care Services</div>
            <button class="game-btn btn-green" onclick="showScreen('screenDetails')">START MISSION</button>
        </div>

        <div id="screenDetails" style="display: none; flex-direction: column; justify-content: center; height: 100%;">
            <div class="story-header">üìã DEPLOYMENT</div>
            <div class="form-group">
                <label>ST. LUKE'S SITE</label>
                <select id="playerSite">
                    <option value="Quezon City">Quezon City</option>
                    <option value="Global City">Global City</option>
                </select>
            </div>
            <div class="form-group">
                <label>EMPLOYEE NUMBER</label>
                <input type="number" id="playerNum" inputmode="numeric" placeholder="Enter number only">
            </div>
            <button class="game-btn btn-green" onclick="validateDetails()">CONFIRM</button>
        </div>

        <div id="screenBriefing" style="display: none; flex-direction: column; justify-content: center; height: 100%;">
            <div class="ambo-avatar"><div class="ambo-stripe"></div><div class="ambo-light"></div></div>
            <div class="story-header">üí¨ AMBO SPEAKS:</div>
            <div id="storyContent" class="story-text"></div>
            <button id="storyBtn" class="game-btn btn-green" onclick="nextStory()">NEXT</button>
        </div>

        <div id="screenQuiz" style="display: none; flex-direction: column; justify-content: center; height: 100%;">
            <div id="feedbackMsg"></div>
            <div class="question-text" id="qText">Question?</div>
            <div id="optionsContainer"></div>
        </div>
    </div>

    <div class="progress-container"><div id="progressBar"></div></div>
    <button onclick="location.reload()" class="game-btn restart-btn" style="background:#c0392b; margin-top:10px; font-size:10px; padding:5px 10px;">RESTART MISSION</button>
</div>

<script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const distText = document.getElementById('dist'), qErrorText = document.getElementById('qErrors'), crashText = document.getElementById('crashCount'), hudPlayerID = document.getElementById('hudPlayerID'), progBar = document.getElementById('progressBar'), mainOverlay = document.getElementById('mainOverlay'), feedbackMsg = document.getElementById('feedbackMsg');

    let distance = 0, crashes = 0, wrongAnswers = 0, isPaused = true, inQuiz = false, gameStarted = false;
    let spawnTimer = 0, roadOffset = 0, invincibilityFrames = 0, arriving = false, missionComplete = false, launchAnimation = false;
    let hospitalY = -400, storyPart = 0;
    const WIN_DISTANCE = 6000;

    const ambulance = { x: 165, y: 450, w: 35, h: 60, speed: 8 };
    let traffic = [];
    const keys = {};

    window.addEventListener('keydown', e => keys[e.code] = true);
    window.addEventListener('keyup', e => keys[e.code] = false);

    canvas.addEventListener('touchmove', (e) => {
        if (isPaused || !gameStarted || inQuiz) return;
        let rect = canvas.getBoundingClientRect();
        let touchX = e.touches[0].clientX - rect.left;
        let scaleX = canvas.width / rect.width;
        ambulance.x = (touchX * scaleX) - (ambulance.w / 2);
        if (ambulance.x < 10) ambulance.x = 10;
        if (ambulance.x > canvas.width - ambulance.w - 10) ambulance.x = canvas.width - ambulance.w - 10;
        e.preventDefault();
    }, { passive: false });

    const amboStory = [
        "Beep Beep! Partner! I'm Ambo üöë. We have a priority transport for St. Luke's!",
        "Documentation errors are dangerous! Each Error drops patient safety by 2%. Each traffic Crash drops it by 5%.",
        "Dodge traffic by dragging me or using Arrow Keys. My terminal will prompt you at every dead-zone. Ready?"
    ];

    const questions = [
        { q: "Which URL is used to access the O-CIS portal?", a: ["hospitalportal.stluke.com.ph:3031", "10.10.60.95:8081/login", "portal.stlukes.com.ph", "ocis.stlukes.com.ph"], correct: 2 },
        { q: "Select which tab for Patient Full Name/DOB during registration?", a: ["Supplemental", "Basic", "Visit", "Clinical"], correct: 1 },
        { q: "Tick which option for critical patients to process faster?", a: ["Licensed Census", "Non-Census", "Express Registration", "VIP"], correct: 2 },
        { q: "What message appears if 'Search' finds no record?", a: ["Entry Not Found", "No Results Found", "User Unknown", "Create New"], correct: 1 },
        { q: "Select which unit for ED in QC during registration?", a: ["QC-ER", "QC-EMERGENCY", "QC-ED", "QC-TRIAGE"], correct: 2 },
        { q: "Correct path to access scanning via OPAL?", a: ["File > Scan", "Tools > Opal Scanning", "Document > Start Scan", "Tools > Paper-Based"], correct: 1 },
        { q: "What characterizes an O-CIS 'Significant Field'?", a: ["Cannot save if empty", "Can save but tagged 'Incomplete'", "Billing only", "Needs co-signer"], correct: 1 },
        { q: "Action required to view a saved document?", a: ["Single-click name", "Click Summary", "Double-click name in Documents", "Tools > Viewer"], correct: 2 },
        { q: "Co-signer radio button for Attending Physicians?", a: ["Other", "Current Provider", "Medical Director", "Referring"], correct: 1 },
        { q: "How to add a comment to a Flowsheet cell?", a: ["Double-click", "Right-click > Enter Comment", "Actions button", "Summary Views"], correct: 1 },
        { q: "Option to present Tracking Board on unit monitor?", a: ["Monitor View", "Display Board", "Unit Broadcast", "Full Screen"], correct: 1 },
        { q: "Button to stop a flowsheet parameter no longer needed?", a: ["Delete", "Cancel", "Discontinue", "Remove"], correct: 2 },
        { q: "Button to return to patient list from tracking board?", a: ["Exit Board", "Close", "Patient List", "Main Menu"], correct: 2 },
        { q: "Where can the Order Entry Worksheet be accessed?", a: ["Main Toolbar only", "Main Toolbar or Patient Header", "Flowsheet only", "Registration"], correct: 1 },
        { q: "Radio button for patient with no allergies?", a: ["N/A", "No Known Allergies", "Negative", "Unknown"], correct: 1 },
        { q: "Besides browsing, how else to search clinical orders?", a: ["Barcode scan", "Type in search field", "Filter ICD10", "Recently Used"], correct: 1 },
        { q: "What is the 'Allergy Summary View' during ordering?", a: ["Billing requirement", "System safety feature", "Medication error", "Required note"], correct: 1 },
        { q: "Status of specimen order after successful processing?", a: ["Pending Collection", "Received", "Collected", "Dispatched"], correct: 2 },
        { q: "Co-signers required for Carrying Out Blood Transfusion?", a: ["None", "One", "Two", "Three"], correct: 2 },
        { q: "Override reason if no barcode present for transfusion?", a: ["Emergency Use", "No Barcode Present", "System Offline", "Manual Entry"], correct: 1 },
        { q: "Mandatory for High Alert Medication (HAM) validation?", a: ["Physician verbal", "Witnessed/Co-Signature", "ICD10 code", "Consent"], correct: 1 },
        { q: "Rx Verify Override Reason for ER medications?", a: ["Pharmacy Closed", "Emergency Situation", "Doctor's Request", "Life Threatening"], correct: 1 },
        { q: "Which URL is specifically for CSS Charging in SLB?", a: ["10.10.60.95:8081", "hospitalportal.stluke.com.ph:3031", "portal.stlukes.com.ph", "css.stlukes.ph"], correct: 1 },
        { q: "Where to find encoded items before submitting in SLB?", a: ["Pending List", "Supply Inventory", "Order Cart", "Checked Items"], correct: 2 },
        { q: "Page to update financial class (HMO/Individual)?", a: ["O-CIS Registration", "E.R. Landing Page", "Demographics", "Billing"], correct: 1 },
        { q: "Required printout for CSS department claiming?", a: ["Orders/Charges screenshot", "Patient ID", "Physician Order", "Admission form"], correct: 0 },
        { q: "Requirement for Discharge Diagnosis in legal docs?", a: ["Physician Sign", "ICD10 code", "Time", "Patient PIN"], correct: 1 },
        { q: "Order that stops further entries in patient chart?", a: ["Discharge Patient", "For Billing Discharge", "Ready for Billing", "Stop All Orders"], correct: 2 },
        { q: "Request type unit for replacement of busted lights?", a: ["FME-Electrical Engineering", "BMED", "Housekeeping", "IT Support"], correct: 0 },
        { q: "Document automatically printed after discharge Clearing?", a: ["Pharmacy Slip", "GATE PASS", "Billing Statement", "Clinical Summary"], correct: 1 }
    ];

    function showScreen(screenId) {
        mainOverlay.querySelectorAll(':scope > div').forEach(div => div.style.display = 'none');
        document.getElementById(screenId).style.display = 'flex';
    }

    function validateDetails() {
        const val = document.getElementById('playerNum').value;
        if (!val) { alert("Enter employee number"); return; }
        hudPlayerID.innerText = val;
        storyPart = 0;
        showStoryPart();
        showScreen('screenBriefing');
    }

    function showStoryPart() {
        document.getElementById('storyContent').innerHTML = amboStory[storyPart];
        document.getElementById('storyBtn').innerText = storyPart === amboStory.length - 1 ? "üöÄ LAUNCH AMBO" : "NEXT";
    }

    function nextStory() {
        if (storyPart < amboStory.length - 1) { storyPart++; showStoryPart(); }
        else { startMission(); }
    }

    function startMission() {
        mainOverlay.style.display = 'none';
        isPaused = false; gameStarted = true; launchAnimation = true;
        ambulance.y = 600; 
    }

    function triggerCheckpoint() {
        inQuiz = true; isPaused = true;
        mainOverlay.style.display = 'flex';
        showScreen('screenQuiz');
        feedbackMsg.style.display = 'none';
        showQuestion();
    }

    function showQuestion() {
        const q = questions[currentQuestionIndex];
        document.getElementById('qText').innerText = q.q;
        const container = document.getElementById('optionsContainer');
        container.innerHTML = '';
        q.a.forEach((opt, i) => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerText = (i+1) + ". " + opt;
            btn.onclick = () => handleAnswer(i);
            container.appendChild(btn);
        });
    }

    function handleAnswer(idx) {
        if (idx === questions[currentQuestionIndex].correct) {
            feedbackMsg.innerText = "‚úÖ Correct!";
            feedbackMsg.className = "correct";
            feedbackMsg.style.display = "block";
            currentQuestionIndex++;
            setTimeout(() => {
                feedbackMsg.style.display = "none";
                if (currentQuestionIndex % 5 !== 0 && currentQuestionIndex < 30) showQuestion();
                else resumeGame();
            }, 800);
        } else {
            distance = Math.max(0, distance - 250); 
            wrongAnswers++;
            qErrorText.innerText = wrongAnswers;
            feedbackMsg.innerText = "‚ùå Wrong answer!";
            feedbackMsg.className = "wrong";
            feedbackMsg.style.display = "block";
        }
    }

    function resumeGame() {
        inQuiz = false; isPaused = false;
        mainOverlay.style.display = 'none';
        if (currentQuestionIndex >= 30) arriving = true;
        else distance += 20; // Recalibrated nudge to bypass stuck distance
    }

    function drawCar(car) {
        ctx.fillStyle = car.color; ctx.fillRect(car.x, car.y, car.w, car.h);
        ctx.fillStyle = 'rgba(255,255,255,0.2)'; ctx.fillRect(car.x+4, car.y+15, car.w-8, 25);
        ctx.fillStyle = '#000'; ctx.fillRect(car.x+6, car.y+10, car.w-12, 6);
        ctx.fillStyle = '#111';
        ctx.fillRect(car.x-2, car.y+10, 3, 12); ctx.fillRect(car.x+car.w-1, car.y+10, 3, 12);
        ctx.fillRect(car.x-2, car.y+car.h-22, 3, 12); ctx.fillRect(car.x+car.w-1, car.y+car.h-22, 3, 12);
    }

    function drawHospital() {
        ctx.fillStyle = '#ddd'; ctx.fillRect(30, hospitalY, 300, 320);
        ctx.fillStyle = '#add8e6';
        for(let i=0; i<4; i++) {
            for(let j=0; j<4; j++) { ctx.fillRect(50 + (i*70), hospitalY + 50 + (j*65), 45, 45); }
        }
        ctx.fillStyle = '#ff3e3e'; ctx.font = '900 18px sans-serif'; ctx.textAlign = 'center';
        ctx.fillText("ST. LUKE'S MEDICAL CENTER", 180, hospitalY + 35);
        ctx.fillStyle = '#333'; ctx.fillRect(130, hospitalY + 260, 100, 60);
    }

    function update() {
        if (isPaused || !gameStarted || inQuiz) return;
        
        if (launchAnimation) {
            ambulance.y -= 5; roadOffset += 15;
            if (ambulance.y <= 450) launchAnimation = false;
            return;
        }

        if (arriving) {
            hospitalY += 3; roadOffset += 5;
            if (hospitalY >= 100) {
                ambulance.y -= 2;
                if (ambulance.y <= 280) { isPaused = true; missionComplete = true; }
            }
        } else {
            if (keys['ArrowLeft'] && ambulance.x > 10) ambulance.x -= ambulance.speed;
            if (keys['ArrowRight'] && ambulance.x < canvas.width - ambulance.w - 10) ambulance.x += ambulance.speed;

            distance += 2; roadOffset += 10;
            if (invincibilityFrames > 0) invincibilityFrames--;
            
            // Checkpoints at 1000m, 2000m, 3000m, 4000m, 5000m, 6000m
            if (distance >= 1000 && currentQuestionIndex < 5) triggerCheckpoint();
            else if (distance >= 2000 && currentQuestionIndex < 10) triggerCheckpoint();
            else if (distance >= 3000 && currentQuestionIndex < 15) triggerCheckpoint();
            else if (distance >= 4000 && currentQuestionIndex < 20) triggerCheckpoint();
            else if (distance >= 5000 && currentQuestionIndex < 25) triggerCheckpoint();
            else if (distance >= 6000 && currentQuestionIndex < 30) triggerCheckpoint();

            spawnTimer++;
            if (spawnTimer > 35) {
                const colors = ['#e67e22', '#9b59b6', '#2ecc71', '#34495e', '#f1c40f'];
                traffic.push({ x: Math.random()*(canvas.width-40), y: -100, w: 36, h: 68, speed: 4 + Math.random()*3, color: colors[Math.floor(Math.random()*colors.length)] });
                spawnTimer = 0;
            }

            for (let i = traffic.length-1; i >= 0; i--) {
                traffic[i].y += traffic[i].speed;
                if (invincibilityFrames === 0 && ambulance.x < traffic[i].x + traffic[i].w && ambulance.x + ambulance.w > traffic[i].x && ambulance.y < traffic[i].y + traffic[i].h && ambulance.y + ambulance.h > traffic[i].y) {
                    distance = Math.max(0, distance - 100);
                    crashes++; crashText.innerText = crashes;
                    invincibilityFrames = 60; 
                }
                if (traffic[i].y > canvas.height) traffic.splice(i, 1);
            }
        }
        distText.innerText = Math.floor(distance);
        progBar.style.width = (currentQuestionIndex / 30 * 100) + "%";
    }

    function draw() {
        ctx.clearRect(0,0, canvas.width, canvas.height);
        ctx.fillStyle = '#222'; ctx.fillRect(0,0, canvas.width, canvas.height);
        ctx.strokeStyle = '#f1c40f'; ctx.setLineDash([40, 40]); ctx.lineDashOffset = -roadOffset; ctx.lineWidth = 6;
        ctx.beginPath(); ctx.moveTo(canvas.width/2, 0); ctx.lineTo(canvas.width/2, canvas.height); ctx.stroke();
        if (arriving) drawHospital();
        if (invincibilityFrames % 10 < 5) {
            ctx.fillStyle = '#fff'; ctx.fillRect(ambulance.x, ambulance.y, ambulance.w, ambulance.h);
            ctx.fillStyle = '#ff3e3e'; ctx.fillRect(ambulance.x, ambulance.y + 25, ambulance.w, 10);
            let lightColor = (Math.floor(Date.now()/150)%2) ? '#ff3e3e' : '#00d4ff';
            ctx.fillStyle = lightColor; ctx.fillRect(ambulance.x + 8, ambulance.y - 6, 20, 7);
        }
        if (!arriving) traffic.forEach(drawCar);

        if (missionComplete) {
            let safety = Math.max(0, 100 - (wrongAnswers * 2) - (crashes * 5));
            ctx.fillStyle = 'rgba(0,0,0,0.95)'; ctx.fillRect(10, 150, canvas.width-20, 250);
            ctx.fillStyle = '#00ff88'; ctx.font = 'bold 22px sans-serif'; ctx.textAlign = 'center';
            ctx.fillText("MISSION ACCOMPLISHED!", 180, 210);
            ctx.fillStyle = '#ffcc00'; ctx.font = 'bold 30px sans-serif';
            ctx.fillText(`SAFETY: ${safety}%`, 180, 270);
            ctx.fillStyle = '#fff'; ctx.font = '14px sans-serif';
            ctx.fillText(`Patient Successfully Turned Over.`, 180, 310);
            ctx.fillText(`Employee ID: ${hudPlayerID.innerText}`, 180, 340);
        }
        requestAnimationFrame(draw);
    }
    setInterval(update, 1000/60);
    draw();
</script>
</body>
</html>
