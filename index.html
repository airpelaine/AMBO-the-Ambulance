<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AMBO - Clinical Mission</title>
    <style>
        :root {
            --primary-blue: #00d4ff;
            --emergency-red: #ff3e3e;
            --warning-gold: #ffcc00;
            --success-green: #27ae60;
            --bg-dark: #0f0f0f;
        }

        body { 
            display: flex; justify-content: center; align-items: flex-start; 
            height: 100vh; margin: 0; background: var(--bg-dark); 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; color: white; overflow: hidden;
            touch-action: none;
            padding-top: 15px;
        }

        .container { 
            position: relative; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            width: 100%; 
            max-width: 420px; 
            margin-top: 60px;
        }

        canvas { 
            background: #1a1a1a; 
            border: 3px solid #333; 
            border-radius: 16px; 
            width: 92%; 
            height: auto; 
            box-shadow: 0 0 40px rgba(0,212,255,0.15); 
            cursor: crosshair;
        }
        
        .hud-header-tag { 
            position: absolute; top: -50px; left: 4%; right: 4%;
            display: flex; justify-content: space-between; align-items: center;
            font-size: 11px; color: #fff; background: rgba(30, 30, 30, 0.9); 
            padding: 8px 12px; border-radius: 8px; border: 1px solid #444;
            letter-spacing: 1px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        .stats-bar {
            width: 92%; display: flex; justify-content: space-between;
            margin-bottom: 8px; font-size: 12px; font-weight: bold;
        }
        .stat-item { display: flex; align-items: center; gap: 4px; }
        .stat-red { color: var(--emergency-red); }
        .stat-yellow { color: var(--warning-gold); }
        .stat-blue { color: var(--primary-blue); }

        #mainOverlay {
            position: absolute; top: 0px; left: 4%; right: 4%; bottom: 80px;
            background: rgba(10, 10, 10, 0.95); border: 2px solid var(--primary-blue); border-radius: 20px;
            display: flex; flex-direction: column; padding: 20px; z-index: 100;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
        }

        .story-header { font-size: 22px; color: var(--emergency-red); font-weight: 900; text-align: center; margin-bottom: 10px; text-transform: uppercase; }
        .story-text { 
            font-size: 14px; color: #eee; margin-bottom: 15px; line-height: 1.5; 
            text-align: center; background: rgba(255,255,255,0.05); padding: 15px; 
            border-radius: 12px; border-left: 4px solid var(--primary-blue);
            transition: opacity 0.4s ease;
        }
        
        .question-text { font-size: 15px; margin-bottom: 15px; line-height: 1.4; color: #fff; font-weight: bold; }
        
        .option-btn { 
            background: #252525; text-align: left; margin-bottom: 8px; padding: 14px; 
            border-radius: 10px; font-size: 13px; border: 1px solid #444; width: 100%; color: white;
            transition: all 0.2s ease; cursor: pointer;
        }
        .option-btn:active { transform: scale(0.98); background: #333; }
        
        #feedbackMsg { font-weight: bold; text-align: center; margin-bottom: 10px; font-size: 18px; display: none; padding: 10px; border-radius: 8px; }
        .correct { color: var(--success-green); background: rgba(39, 174, 96, 0.1); }
        .wrong { color: var(--emergency-red); background: rgba(255, 62, 62, 0.1); }

        .form-group { margin-bottom: 12px; text-align: left; width: 100%; }
        .form-group label { display: block; font-size: 10px; color: var(--primary-blue); margin-bottom: 5px; font-weight: bold; text-transform: uppercase; }
        .form-group input, .form-group select { 
            width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #444; 
            background: #111; color: white; box-sizing: border-box; font-size: 14px;
        }

        .ambo-avatar { width: 50px; height: 80px; margin: 0 auto 15px; position: relative; background: #fff; border-radius: 4px; border: 2px solid #ccc; }
        .ambo-avatar::after { content: ''; position: absolute; top: 30px; left: 0; width: 100%; height: 12px; background: var(--emergency-red); }
        .siren-light {
            position: absolute; top: -10px; left: 50%; transform: translateX(-50%);
            width: 30px; height: 10px; border-radius: 5px;
            animation: flickerSiren 0.2s infinite alternate;
        }
        @keyframes flickerSiren {
            0% { background: var(--emergency-red); box-shadow: 0 0 10px var(--emergency-red); }
            100% { background: var(--primary-blue); box-shadow: 0 0 10px var(--primary-blue); }
        }

        .progress-container { width: 92%; height: 8px; background: #222; border-radius: 10px; margin-top: 15px; overflow: hidden; border: 1px solid #333; }
        #progressBar { width: 0%; height: 100%; background: linear-gradient(90deg, var(--primary-blue), #00ff88); transition: width 0.4s ease; }
        
        .game-btn { padding: 16px 24px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; color: white; text-transform: uppercase; letter-spacing: 1px; }
        .btn-green { background: var(--success-green); width: 100%; margin-top: 10px; box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3); }
    </style>
</head>
<body>

<div class="container">
    <div class="hud-header-tag">
        <span id="hudModuleTitle">CLINICAL SERVICES</span>
        <span id="hudPlayerID">ID: ---</span>
    </div>

    <div class="stats-bar">
        <div class="stat-item stat-red">‚ùå ERRORS: <span id="qErrors">0</span></div>
        <div class="stat-item stat-yellow">üí• CRASHES: <span id="crashCount">0</span></div>
        <div class="stat-item stat-blue">üèÅ <span id="dist">0</span>m</div>
    </div>
    
    <canvas id="game" width="360" height="580"></canvas>
    
    <div id="mainOverlay">
        <div id="screenStart" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%;">
            <h1 style="margin: 0; color: #fff; font-size: 28px;">üöë AMBO</h1>
            <p style="color: var(--warning-gold); font-size: 12px; letter-spacing: 2px; margin-bottom: 30px;">THE CLINICAL AMBULANCE</p>
            <button class="game-btn btn-green" onclick="showScreen('screenDetails')">BEGIN MISSION</button>
        </div>

        <div id="screenDetails" style="display: none; flex-direction: column; justify-content: center; height: 100%;">
            <div class="story-header">DEPLOYMENT</div>
            
            <div class="form-group">
                <label>Training Module</label>
                <select id="trainingModule">
                    <option value="Acute Care">Acute Care Competency</option>
                    <option value="Surgical Care">Surgical Care</option>
                    <option value="Emergency Care Services">Emergency Care Services</option>
                </select>
            </div>

            <div class="form-group">
                <label>Assigned Site</label>
                <select id="playerSite">
                    <option value="Quezon City">St. Luke's - Quezon City</option>
                    <option value="Global City">St. Luke's - Global City</option>
                </select>
            </div>
            <div class="form-group">
                <label>Employee Number</label>
                <input type="number" id="playerNum" inputmode="numeric" placeholder="Enter employee number">
            </div>
            <button class="game-btn btn-green" onclick="validateDetails()">CONFIRM DISPATCH</button>
        </div>

        <div id="screenBriefing" style="display: none; flex-direction: column; justify-content: center; height: 100%;">
            <div class="ambo-avatar"><div class="siren-light"></div></div>
            <div class="story-header">BRIEFING</div>
            <div id="storyContent" class="story-text"></div>
            <button id="storyBtn" class="game-btn btn-green" onclick="nextStory()">NEXT</button>
        </div>

        <div id="screenQuiz" style="display: none; flex-direction: column; justify-content: center; height: 100%;">
            <div id="feedbackMsg"></div>
            <div class="question-text" id="qText"></div>
            <div id="optionsContainer"></div>
        </div>
    </div>

    <div class="progress-container"><div id="progressBar"></div></div>
    <button onclick="location.reload()" style="background:none; border:none; color:#555; margin-top:10px; font-size:10px; cursor:pointer;">RESTART SIMULATION</button>
</div>

<script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const distText = document.getElementById('dist'), 
          qErrorText = document.getElementById('qErrors'), 
          crashText = document.getElementById('crashCount'), 
          hudPlayerID = document.getElementById('hudPlayerID'),
          hudModuleTitle = document.getElementById('hudModuleTitle'),
          progBar = document.getElementById('progressBar'), 
          mainOverlay = document.getElementById('mainOverlay'), 
          feedbackMsg = document.getElementById('feedbackMsg');

    let distance = 0, crashes = 0, wrongAnswers = 0, currentQuestionIndex = 0;
    let isPaused = true, inQuiz = false, gameStarted = false;
    let spawnTimer = 0, roadOffset = 0, invincibilityFrames = 0, arriving = false, missionComplete = false;
    let hospitalY = -400, storyPart = 0;

    const ambulance = { x: 162, y: 480, w: 36, h: 70, speed: 7 };
    let traffic = [];
    const keys = {};

    window.addEventListener('keydown', e => keys[e.code] = true);
    window.addEventListener('keyup', e => keys[e.code] = false);

    canvas.addEventListener('touchmove', (e) => {
        if (isPaused || !gameStarted || inQuiz) return;
        let rect = canvas.getBoundingClientRect();
        let touchX = e.touches[0].clientX - rect.left;
        let scaleX = canvas.width / rect.width;
        ambulance.x = (touchX * scaleX) - (ambulance.w / 2);
        if (ambulance.x < 15) ambulance.x = 15;
        if (ambulance.x > canvas.width - ambulance.w - 15) ambulance.x = canvas.width - ambulance.w - 15;
        e.preventDefault();
    }, { passive: false });

    // --- UPDATED AMBO DIALOGUE WITH HTML BOLD TAGS ---
    const amboStory = [
        "Hey there, Partner! üëã I'm <b>AMBO</b>, your clinical mission partner. We've got a patient in the back depending on us to get to the hospital. You ready to roll?",
        "Precision is everything today. If you miss a clinical question, our patient's stability drops by <b>2%</b>. If you clip another car, that's a <b>5%</b> hit.",
        "I'll handle the siren, you handle the steering. <b>Drag your finger</b> across the screen (or use <b>Arrow Keys</b>) to dodge traffic. We'll pause for chart updates every 1,000 meters.",
        "Our patient's safety is in your hands. Let's show them why we're the best at St. Luke's. Launch when you're ready!"
    ];

    const emergencyQuestions = [
        { q: "Which URL is used to access the O-CIS portal?", a: ["hospitalportal.stluke.com.ph:3031", "10.10.60.95:8081/login", "portal.stlukes.com.ph", "ocis.stlukes.com.ph"], correct: 2 },
        { q: "Select which tab for Patient Full Name/DOB during registration?", a: ["Supplemental", "Demographics", "Visit", "Clinical"], correct: 1 },
        { q: "Tick which option for critical patients to be admitted faster?", a: ["Licensed Census", "Non-Census", "Express Registration", "VIP"], correct: 2 },
        { q: "What message appears if 'Search' finds no record?", a: ["Entry Not Found", "No Results Found", "User Unknown", "Create New"], correct: 1 },
        { q: "Which unit should be selected for ED in QC during registration?", a: ["QC-ER", "QC-EMERGENCY", "QC-ED", "QC-TRIAGE"], correct: 2 },
        { q: "Correct path to access scanning via OPAL?", a: ["File > Scan", "Tools > Opal Scanning", "Document > Start Scan", "Tools > Paper-Based"], correct: 1 },
        { q: "What characterizes an O-CIS 'Significant Field'?", a: ["Cannot save if empty", "Can save but tagged 'Incomplete'", "Billing only", "Needs co-signer"], correct: 1 },
        { q: "Action required to view a saved document?", a: ["Single-click name", "Click Summary", "Double-click specific document", "Tools > Viewer"], correct: 2 },
        { q: "Co-signer radio button for Attending Physicians?", a: ["Other", "Current Provider", "Medical Director", "Referring"], correct: 1 },
        { q: "How to add a comment to a Flowsheet cell?", a: ["Double-click", "Right-click > Enter Comment", "Actions button", "Summary Views"], correct: 1 },
        { q: "Option to present Tracking Board on unit monitor?", a: ["Monitor View", "Display Board", "Unit Broadcast", "Full Screen"], correct: 1 },
        { q: "Button to deactivate a flowsheet parameter no longer needed?", a: ["Delete", "Cancel", "Discontinue", "Remove"], correct: 2 },
        { q: "Button to return to patient list from tracking board?", a: ["Exit Board", "Close", "Patient List", "Main Menu"], correct: 2 },
        { q: "Where can the Order Entry Worksheet be accessed?", a: ["Main Toolbar only", "Main Toolbar or Patient Header", "Flowsheet only", "Registration"], correct: 1 },
        { q: "Radio button for patient with no allergies?", a: ["N/A", "No Known Allergies", "Negative", "Unknown"], correct: 1 },
        { q: "Besides browsing, how else to search clinical orders?", a: ["Barcode scan", "Type in search field", "Filter ICD10", "Recently Used"], correct: 1 },
        { q: "What is the 'Allergy Summary View' during ordering?", a: ["Billing requirement", "System safety feature", "Medication error", "Required note"], correct: 1 },
        { q: "Status of specimen order once endorsed to performing unit?", a: ["Pending Collection", "Received", "Collected", "Dispatched"], correct: 1 },
        { q: "Co-signers required for Carrying Out Blood Transfusion?", a: ["None", "One", "Two", "Three"], correct: 2 },
        { q: "Override reason if no barcode present for transfusion?", a: ["Emergency Use", "No Barcode Present", "System Offline", "Manual Entry"], correct: 1 },
        { q: "Mandatory for High Alert Medication (HAM) validation?", a: ["Physician verbal", "Witnessed/Co-Signature", "ICD10 code", "Consent"], correct: 1 },
        { q: "Rx Verify Override Reason for ER medications?", a: ["Pharmacy Closed", "Emergency Situation", "Doctor's Request", "Life Threatening"], correct: 1 },
        { q: "Which URL is specifically for CSS Charging in SLB?", a: ["10.10.60.95:8081", "hospitalportal.stluke.com.ph:3031", "portal.stlukes.com.ph", "css.stlukes.ph"], correct: 1 },
        { q: "Where to find encoded items before submitting in SLB?", a: ["Pending List", "Supply Inventory", "Order Cart", "Checked Items"], correct: 2 },
        { q: "Page to update financial class (HMO/Individual)?", a: ["O-CIS Registration", "E.R. Landing Page", "Demographics", "Billing"], correct: 1 },
        { q: "Required printout for CSS department claiming?", a: ["Orders/Charges screenshot", "Patient ID", "Physician Order", "Admission form"], correct: 0 },
        { q: "Requirement for Discharge Diagnosis in legal docs?", a: ["Physician Sign", "ICD10 code", "Time", "Patient PIN"], correct: 1 },
        { q: "Order that stops further entries in patient chart?", a: ["Discharge Patient", "For Billing Discharge", "Ready for Billing", "Stop All Orders"], correct: 2 },
        { q: "Request type for replacement of busted lights in Patient Flow?", a: ["FME-Electrical Engineering", "BMED", "Housekeeping", "IT Support"], correct: 0 },
        { q: "Document automatically printed after discharge visit?", a: ["Pharmacy Slip", "GATE PASS", "Billing Statement", "Clinical Summary"], correct: 1 }
    ];

    const acuteCareQuestions = [
        { q: "Which URL should be used to access the St. Luke‚Äôs portal for O-CIS?", a: ["stlukes.com.ph", "portal.stlukes.com.ph/", "ocis.stlukes.com.ph", "hospitalportal.stlukes.com.ph"], correct: 1 },
        { q: "When creating a Personal Visit List, which button must be held down to select multiple assigned patients?", a: ["Shift", "Alt", "CTRL", "Command"], correct: 2 },
        { q: "What is the specific name of the production environment for O-CIS?", a: ["OCIS-TEST", "OCIS-PROD", "OCIS-LIVE", "OCIS-MAIN"], correct: 1 },
        { q: "Where is the 'Enter Order' button located in the EMR interface?", a: ["CHART LEVEL Toolbar", "Options Panel", "Patient Header", "Flowsheet Tab"], correct: 2 },
        { q: "What information is required every time a nurse submits an order for authentication?", a: ["Employee ID", "Fingerprint Scan", "Password", "Manager‚Äôs Approval"], correct: 2 },
        { q: "Which 'Session Type' should be chosen when entering a standard medical order?", a: ["Emergency", "Standard", "Urgent", "Routine"], correct: 1 },
        { q: "How can a nurse modify an order in the Cart but not yet submitted?", a: ["Right-click Delete", "Double-click order or Edit", "Must be re-entered", "Contact IT"], correct: 1 },
        { q: "Which tab is used to create a 'Pending Incoming Visit List'?", a: ["Patient List", "Clinical Summary", "Orders", "Flowsheet"], correct: 0 },
        { q: "Transferring a patient to a different room, which section is used?", a: ["Temporary", "Assigned", "Ancillary", "Discharge"], correct: 1 },
        { q: "When AN ADMITTED patient is moved to an ancillary department (like Radiology) FOR A PROCEDURE, which section of the Location icon is used?", a: ["Assigned", "Permanent", "Temporary", "Outpatient"], correct: 2 },
        { q: "What happens if a field tagged as 'Significant' is left blank?", a: ["Cannot save", "Saves but tagged 'Incomplete'", "System fills N/A", "Prevents logout"], correct: 1 },
        { q: "Which assessment tool is specifically used for pediatric fall risk?", a: ["Morse Fall Risk", "Humpty Dumpty Fall Risk", "Obstetric Fall Risk", "Braden Scale"], correct: 1 },
        { q: "How do you add a new time column to a flowsheet?", a: ["File > New Column", "Column Options or right-click gray area", "Drag and drop", "Automatic"], correct: 1 },
        { q: "To remove a parameter flowsheet entered in error, which action is used?", a: ["Delete", "Cancel", "Discontinue", "Hide"], correct: 1 },
        { q: "In Medication History, what does a RED circle icon indicate?", a: ["History complete", "Not collected/started", "No allergies", "High-alert meds"], correct: 1 },
        { q: "What are the first two steps in the KBMA workflow?", a: ["Scan drug, scan patient", "Scan patient barcode, scan drug barcode", "Check ID, ask name", "Open MAR, scan drug"], correct: 1 },
        { q: "What is required when administering High Alert Medications (HAM)?", a: ["Physician verbal", "Witnessed/Co-Signature", "Pharmacy approval", "2nd patient scan"], correct: 1 },
        { q: "Tool used to coordinate with Pharmacy regarding a medication refill?", a: ["Order Worksheet", "Order Message Manager", "Flowsheet Comments", "Signature Manager"], correct: 1 },
        { q: "Under what circumstance would a nurse 'Suspend' a medication?", a: ["Patient sleeping", "Patient on NPO Pre-Op", "Out of stock", "Later dose request"], correct: 1 },
        { q: "Document to be printed (1 copy) before claiming blood product?", a: ["Admission Note", "Consent for Blood Transfusion", "Vital Signs", "Lab Results"], correct: 1 },
        { q: "When carrying out a blood transfusion in the Worklist, what must be selected if THE PRODUCT HAS NO BARCODE for verification?", a: ["Manual Entry", "No Barcode Present", "Override Manager", "Emergency Release"], correct: 1 },
        { q: "How many co-signers are required for Carrying Out Blood Transfusion?", a: ["One", "Two", "Three", "None"], correct: 1 },
        { q: "Which system is used for charging miscellaneous supplies and clinical equipment?", a: ["O-CIS", "SLB (St. Luke's Billing)", "OPAL", "Patient Flow"], correct: 1 },
        { q: "What must be printed for CSS claiming after encoding in SLB?", a: ["Patient Header", "Supplies tab screenshot (2 copies)", "Medical Record", "MD Order"], correct: 1 },
        { q: "Which tool is used to SUBMIT A MAINTENANCE REQUEST?", a: ["Worklist Manager", "Patient Flow", "Order Entry", "Clinical Summary"], correct: 1 },
        { q: "Which order in OCIS stops further entries in the chart?", a: ["Discharge Patient", "Ready for Billing", "Final Summary", "Gate Pass"], correct: 1 },
        { q: "To pull up medication instructions created by MDs into the nursing discharge note, which FEATURE is used?", a: ["Refresh", "GET MED LIST", "Import Data", "Sync"], correct: 1 },
        { q: "What is required for the 'For Billing Discharge' option to appear in the SLB Nursing Unit landing page?", a: ["The patient must be physically out of the room", "A CORE discharge order made", "All laboratory results must be complete", "The patient must have paid their bill in full"], correct: 1 },
        { q: "What is the 'Read Only Environment' (ROE) used for?", a: ["Edit orders", "BCP when system is down", "Student practice", "Admin data"], correct: 1 },
        { q: "Specific browser URL to access ROE at St. Luke‚Äôs QC?", a: ["portal.stlukes.ph", "slmcqcprodbcs4/bcs/login", "backup.stlukes.ph", "roe.stlukes.ph"], correct: 1 }
    ];

    const surgicalCareQuestions = [
        { q: "Which EMR module is used to LOG a new outpatient visit?", a: ["Scheduling", "Registration", "Surgery Care", "Flowsheets"], correct: 1 },
        { q: "When registering a patient who is not yet at the hospital, what status should the visit be set to?", a: ["Adm/Arr", "Pre-Reg", "Outpatient", "In-Patient"], correct: 1 },
        { q: "In which registration tab are the 'Care Level' and 'Attending Provider' fields located?", a: ["Basic Tab", "Visit Criteria", "Visit Demographics", "Location"], correct: 2 },
        { q: "According to the GUIDELINES, how should patient information be typed into the registration window?", a: ["lowercase", "Sentence case", "UPPERCASE", "Italicized"], correct: 2 },
        { q: "Which electronic device is used for capturing patient signatures on digital consent forms?", a: ["Stylus Pen", "TOPAZ", "Tablet PC", "Scanner"], correct: 1 },
        { q: "To book a surgical case via Demand Booking, what button must be clicked after highlighting the patient name?", a: ["Create New Visit", "Edit Patient/Book", "Add Procedure", "Schedule Roster"], correct: 1 },
        { q: "Which values autopopulate in the 'Supplemental Info' tab once a specific procedure is selected?", a: ["Surgeon and Anesthesiologist", "Date and Room Number", "Description, Preference Card, and Duration", "MRN and Visit Number"], correct: 2 },
        { q: "If a procedure requires specific anatomical details (e.g., Left or Right), which fields must be filled?", a: ["Location and Unit", "Laterality and Site", "Primary and Secondary", "Code and Description"], correct: 1 },
        { q: "Where should the case 'Confirmation Code' be documented during the booking process?", a: ["Visit Demographics", "Patient Header", "Booking Comments", "Case Status"], correct: 2 },
        { q: "Which of the following DOCUMENTS IS ACCOMPLISHED PRIOR SURGERY/PROCEDURE?", a: ["PreOp Nursing Note", "IntraOp Record", "Post Op Nursing Note", "Recovery Discharge"], correct: 0 },
        { q: "When using Ad-Hoc Booking, which menu bar option is selected to enter a surgical case?", a: ["File", "Registration", "Surgery", "Tools"], correct: 2 },
        { q: "Who is responsible for updating Preference Cards with new items?", a: ["Surgeon", "OR/DR Nurse Unit Manager", "CSS Staff", "IT Support"], correct: 1 },
        { q: "To update case participants (Surgeons/Anesthesiologists), which tab in Surgery Case Details must be opened?", a: ["Case Usage", "Intra-op", "Supplemental Info", "Document Info"], correct: 1 },
        { q: "During an ongoing case, in which column should you adjust the quantity of items used?", a: ["Qty column", "Used column", "Planned column", "Status column"], correct: 1 },
        { q: "What is the first step when documenting and charging for an Implant?", a: ["Search for CHRG ANS", "Open Surgery Case List", "Click on 'Implants' on the Main Toolbar", "Click Add New Visit"], correct: 2 },
        { q: "If an implant price is unavailable, what amount should be encoded in the system?", a: ["1.00", "0", "Market Value", "Leave it blank"], correct: 1 },
        { q: "What must be done immediately after a surgical specimen is collected to begin EMR documentation?", a: ["Print Case List", "Right click the specimen order and select 'Add Specimen...'", "Close the patient chart", "Open the PACU Flowsheet"], correct: 1 },
        { q: "To print a specimen label, what technical detail must be copied from the order window?", a: ["Patient MRN", "Visit Number", "Order ID", "Surgeon Name"], correct: 2 },
        { q: "Which policy governs 'Specimen Collection, Identification and Handling'?", a: ["Leadership 1-114-2", "Patient Care and Safety 1-47-6", "Clinical Records Management 1-13-7", "Regulatory 1-15-2"], correct: 1 },
        { q: "In the 'Add Specimen' window, what specific INFORMATION is required?", a: ["Arrival Time", "Collection Start Date and Start Time", "Pathology Receipt Time", "Surgeon Approval Time"], correct: 1 },
        { q: "Which icon facilitates the patient location update from OR to PACU?", a: ["Enter Document icon", "Change Location icon", "Enter Order icon", "Signature Manager icon"], correct: 1 },
        { q: "What radio button is selected in the 'Effective' section for an immediate patient transfer?", a: ["Now", "Date & Time", "Pre-Reg", "Schedule"], correct: 0 },
        { q: "Which flowsheet must be searched for and added during recovery documentation?", a: ["Intake and Output", "Assessment and Cares", "PACU Flowsheet", "Plan of Care"], correct: 2 },
        { q: "How do you set a documentation frequency (e.g., every 15 minutes) on a flowsheet?", a: ["Click 'Add Parameter'", "Use the Save Options in the Options Panel to fill out Frequency", "Right click on the time column", "Click 'Modify Row Label'"], correct: 1 },
        { q: "What is the correct method to remove data accidentally entered into a flowsheet cell?", a: ["Use the Delete key", "Right click and select 'Delete Cell Data'", "Click 'Cancel Parameter'", "Highlight and type 'X'"], correct: 1 },
        { q: "When finalizing case usage, who performs the final checking of review items and quantities?", a: ["RN", "CSS", "CN (Charge Nurse)", "Unit Manager"], correct: 2 },
        { q: "If the Planned Procedure matches the Performed Procedure, what must the nurse check?", a: ["The Add icon", "The 'Performed' tickbox", "The 'Post Selected' icon", "The 'Save' button"], correct: 1 },
        { q: "After clicking the 'Post Selected' icon in the Charges tab, the status changes from Pending Post to what?", a: ["Transmitted", "Posted", "Verified", "Closed"], correct: 1 },
        { q: "Which module is used to verify that charges were successfully transmitted to the SLB system?", a: ["Charges Entry, Adjustment and Cancellation (CEAC)", "Nursing Special Units Landing Page", "Surgery Case List", "Business Continuity Solution"], correct: 0 },
        { q: "What must be ticked to remove the temporary location from the patient's header?", a: ["Change Location", "Clear Current Temporary Location", "Arrive/Cancel Arrival", "Discontinue"], correct: 1 }
    ];

    let currentQuestionSet = [];

    function showScreen(screenId) {
        ['screenStart', 'screenDetails', 'screenBriefing', 'screenQuiz'].forEach(s => document.getElementById(s).style.display = 'none');
        document.getElementById(screenId).style.display = 'flex';
    }

    function validateDetails() {
        const val = document.getElementById('playerNum').value;
        const module = document.getElementById('trainingModule').value;
        if (!val) { alert("Please enter your employee number."); return; }
        
        hudPlayerID.innerText = "ID: " + val;
        hudModuleTitle.innerText = module.toUpperCase();
        
        if (module === "Acute Care") {
            currentQuestionSet = acuteCareQuestions;
        } else if (module === "Surgical Care") {
            currentQuestionSet = surgicalCareQuestions;
        } else {
            currentQuestionSet = emergencyQuestions;
        }
        
        storyPart = 0;
        showStoryPart();
        showScreen('screenBriefing');
    }

    // --- REWRITTEN BRIEFING LOGIC WITH FADE ---
    function showStoryPart() {
        const storyBox = document.getElementById('storyContent');
        storyBox.style.opacity = 0;
        
        setTimeout(() => {
            storyBox.innerHTML = amboStory[storyPart];
            storyBox.style.opacity = 1;
        }, 100);

        document.getElementById('storyBtn').innerText = storyPart === amboStory.length - 1 ? "üöÄ DEPLOY NOW" : "CONTINUE";
    }

    function nextStory() {
        if (storyPart < amboStory.length - 1) { 
            storyPart++; 
            showStoryPart(); 
        } else { 
            startMission(); 
        }
    }

    function startMission() {
        mainOverlay.style.display = 'none';
        isPaused = false; gameStarted = true;
    }

    function triggerCheckpoint() {
        inQuiz = true; isPaused = true;
        mainOverlay.style.display = 'flex';
        showScreen('screenQuiz');
        feedbackMsg.style.display = 'none';
        showQuestion();
    }

    function showQuestion() {
        if (currentQuestionIndex >= currentQuestionSet.length) { resumeGame(); return; }
        const q = currentQuestionSet[currentQuestionIndex];
        document.getElementById('qText').innerText = q.q;
        const container = document.getElementById('optionsContainer');
        container.innerHTML = '';
        q.a.forEach((opt, i) => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerText = opt;
            btn.onclick = () => handleAnswer(i);
            container.appendChild(btn);
        });
    }

    function handleAnswer(idx) {
        if (idx === currentQuestionSet[currentQuestionIndex].correct) {
            feedbackMsg.innerText = "‚úì SYSTEM UPDATED";
            feedbackMsg.className = "correct";
            feedbackMsg.style.display = "block";
            currentQuestionIndex++;
            setTimeout(() => {
                feedbackMsg.style.display = "none";
                if (currentQuestionIndex % 5 !== 0 && currentQuestionIndex < currentQuestionSet.length) { showQuestion(); } 
                else { resumeGame(); }
            }, 1000);
        } else {
            wrongAnswers++;
            qErrorText.innerText = wrongAnswers;
            feedbackMsg.innerText = "‚úó DATA ERROR";
            feedbackMsg.className = "wrong";
            feedbackMsg.style.display = "block";
            distance = Math.max(0, distance - 150);
        }
    }

    function resumeGame() {
        inQuiz = false; isPaused = false;
        mainOverlay.style.display = 'none';
        if (currentQuestionIndex >= currentQuestionSet.length) arriving = true;
        distance += 50; 
    }

    function drawAmbulance() {
        if (invincibilityFrames % 10 < 5) {
            ctx.fillStyle = '#fff';
            ctx.fillRect(ambulance.x, ambulance.y, ambulance.w, ambulance.h);
            ctx.fillStyle = '#ff3e3e';
            ctx.fillRect(ambulance.x, ambulance.y + 30, ambulance.w, 12);
            ctx.fillStyle = '#333';
            ctx.fillRect(ambulance.x + 4, ambulance.y + 6, ambulance.w - 8, 15);
            let lightColor = (Math.floor(Date.now()/150)%2) ? '#ff3e3e' : '#00d4ff';
            ctx.fillStyle = lightColor;
            ctx.fillRect(ambulance.x + 6, ambulance.y - 4, 10, 5);
            ctx.fillRect(ambulance.x + 20, ambulance.y - 4, 10, 5);
        }
    }

    function drawCar(car) {
        ctx.fillStyle = car.color;
        ctx.fillRect(car.x, car.y, car.w, car.h);
        ctx.fillStyle = 'rgba(0,0,0,0.3)';
        ctx.fillRect(car.x + 4, car.y + 8, car.w - 8, 12);
    }

    function drawHospital() {
        ctx.fillStyle = '#e0e0e0';
        ctx.fillRect(20, hospitalY, 320, 350);
        ctx.fillStyle = '#ff3e3e';
        ctx.font = 'bold 20px sans-serif'; ctx.textAlign = 'center';
        ctx.fillText("ST. LUKE'S MEDICAL CENTER", 180, hospitalY + 40);
        ctx.fillStyle = '#add8e6';
        for(let i=0; i<3; i++) {
            for(let j=0; j<4; j++) ctx.fillRect(50 + (i*90), hospitalY + 80 + (j*60), 60, 40);
        }
    }

    function update() {
        if (isPaused || !gameStarted || inQuiz) return;
        
        if (arriving) {
            traffic = [];
            hospitalY += 3;
            roadOffset += 4;
            if (hospitalY >= 100) {
                ambulance.y -= 2;
                if (ambulance.y <= 300) { isPaused = true; missionComplete = true; }
            }
        } else {
            if (keys['ArrowLeft'] && ambulance.x > 15) ambulance.x -= ambulance.speed;
            if (keys['ArrowRight'] && ambulance.x < canvas.width - ambulance.w - 15) ambulance.x += ambulance.speed;

            distance += 3;
            roadOffset += 12;
            if (invincibilityFrames > 0) invincibilityFrames--;
            
            const nextCheckpoint = (Math.floor(currentQuestionIndex / 5) + 1) * 1000;
            if (distance >= nextCheckpoint && currentQuestionIndex < currentQuestionSet.length) triggerCheckpoint();

            spawnTimer++;
            if (spawnTimer > 40) {
                const colors = ['#f39c12', '#8e44ad', '#27ae60', '#2980b9'];
                traffic.push({ 
                    x: Math.random()*(canvas.width-50) + 10, y: -100, w: 34, h: 65, 
                    speed: 4 + Math.random()*4, color: colors[Math.floor(Math.random()*colors.length)] 
                });
                spawnTimer = 0;
            }

            for (let i = traffic.length-1; i >= 0; i--) {
                traffic[i].y += traffic[i].speed;
                if (invincibilityFrames === 0 && 
                    ambulance.x < traffic[i].x + traffic[i].w && 
                    ambulance.x + ambulance.w > traffic[i].x && 
                    ambulance.y < traffic[i].y + traffic[i].h && 
                    ambulance.y + ambulance.h > traffic[i].y) {
                    crashes++; crashText.innerText = crashes;
                    invincibilityFrames = 70; distance = Math.max(0, distance - 200);
                }
                if (traffic[i].y > canvas.height) traffic.splice(i, 1);
            }
        }
        distText.innerText = Math.floor(distance);
        progBar.style.width = (currentQuestionIndex / currentQuestionSet.length * 100) + "%";
    }

    function draw() {
        ctx.clearRect(0,0, canvas.width, canvas.height);
        ctx.fillStyle = '#222'; ctx.fillRect(0,0, canvas.width, canvas.height);
        ctx.strokeStyle = '#f1c40f'; ctx.setLineDash([40, 40]); ctx.lineDashOffset = -roadOffset; ctx.lineWidth = 4;
        ctx.beginPath(); ctx.moveTo(canvas.width/2, 0); ctx.lineTo(canvas.width/2, canvas.height); ctx.stroke();
        if (arriving) drawHospital();
        traffic.forEach(drawCar);
        drawAmbulance();
        if (missionComplete) {
            let safety = Math.max(0, 100 - (wrongAnswers * 2) - (crashes * 5));
            ctx.fillStyle = 'rgba(0,0,0,0.9)'; ctx.fillRect(20, 180, canvas.width-40, 220);
            ctx.fillStyle = '#00ff88'; ctx.font = 'bold 22px sans-serif'; ctx.textAlign = 'center';
            ctx.fillText("MISSION COMPLETE", 180, 240);
            ctx.fillStyle = '#fff'; ctx.font = '40px sans-serif'; ctx.fillText(safety + "%", 180, 300);
            ctx.font = '14px sans-serif'; ctx.fillText("PATIENT STABILITY SCORE", 180, 330);
            ctx.fillStyle = '#aaa'; ctx.fillText(hudPlayerID.innerText, 180, 370);
        }
        requestAnimationFrame(draw);
    }
    setInterval(update, 1000/60);
    draw();
</script>
</body>
</html>
